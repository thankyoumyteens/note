# awk 的执行过程

awk 的执行过程可以分为 初始化、处理输入、清理 三个主要阶段。

Awk 执行流程简图

```
+-------------------+
|   初始化阶段      |
|  1. 解析程序结构   |
|  2. 执行 BEGIN 块  |
+-------------------+
          ↓
+-------------------+
|   处理输入阶段     |
|  1. 读入一行输入   |
|  2. 分割为字段     |
|  3. 匹配模式并执行动作 |
|  4. 重复至所有行   |
+-------------------+
          ↓
+-------------------+
|   清理阶段        |
|  执行 END 块      |
+-------------------+
```

1. 初始化阶段(启动时): 在 Awk 程序开始处理输入文件之前，会先完成一些初始化操作:
   - 解析程序结构: Awk 程序由一系列 `模式 { 动作 }` 组成，初始化时会先解析这些结构，将模式和对应的动作存储起来，方便后续匹配
   - 执行 BEGIN 块: 如果程序中存在 BEGIN，则在处理任何输入之前执行其对应的动作。BEGIN 块通常用于初始化变量、打印表头、设置分隔符等
   ```sh
   BEGIN {
       FS = ",";  # 设置分隔符为逗号
       print "姓名,年龄";  # 打印表头
   }
   ```
2. 处理输入阶段(核心阶段): 初始化完成后，Awk 开始逐行处理输入的文件，直到所有输入处理完毕。每行输入的处理流程完全相同，具体步骤如下:
   1. 读取一行输入:
      - 从输入中读取一整行文本(默认以换行符 `\n` 为行分隔符，可在 BEGIN 中通过 `RS` 变量修改)
      - 若读取到文件末尾(EOF)，则结束处理阶段，进入清理阶段
   2. 把行分割为列(`$1`, `$2`, ...)
      - 将当前行按照分隔符(默认是任意空白字符，可通过 `FS` 变量或 `-F` 选项指定)分割为多个列
      - 列变量: `$1` 表示第一列，`$2` 表示第二列，...，`$0` 表示当前行
      - 自动更新内置变量: `NF`(当前行的总列数)、`NR`(当前处理的行号，全局累计)、`FNR`(当前文件内的行号，多文件时重置)等
      - 示例: 若行内容为 `Alice,25` 且 `FS=","`，则 `$1` 是 Alice，`$2` 是 25，`NF` 是 2
   3. 匹配模式并执行动作: 对当前行，按顺序检查程序中所有的 `模式 { 动作 }`，满足模式则执行对应动作
   4. 重复处理下一行: 回到步骤 1，读取下一行输入，直到所有输入处理完毕
3. 清理阶段(处理结束后)
   - 执行 END 块: 如果程序中存在 END 模式，则在处理完所有输入后执行其对应的动作。END 块通常用于汇总结果（如打印统计值）、释放资源等。
   ```sh
   END {
       print "总共有" ,lineCount, "行";  # 打印统计结果
   }
   ```

## 示例

```sh
awk '{print $1, $2} BEGIN {print "开始执行"} END {print "执行完成"}' ./demo.txt
```

输出:

```
开始执行
Alice 25
Bob 30
Charlie 35
执行完成
```
