# 高可用

## 普通集群

普通集群(classic cluster): 会在集群的各个节点之间共享部分数据, 包括: 交换机, 队列元信息。

队列里面的数据只会存储在创建它的节点上，其他节点只存储元数据，和指向这个队列所在节点的指针。

假设 RabbitMQ 中有三个节点 node1, node2, node3。队列 queue1 在 node1 中。如果一个消费者通过 node2 连接，然后来消费 queue1 中的消息, RabbitMQ 会临时在 node1、node2 间进行消息传输，RabbitMQ 会根据 node2 中指向 queue1 的指针，把 node1 中的消息实体取出并经过 node2 发送给消费者。

缺点: 队列所在节点宕机, 则队列中的消息就会丢失。

## 镜像队列

镜像队列(Mirror Queue)会在节点之间同步交换机, 队列和队列中的消息，最终的队列数据会存在于每个节点中，而不像普通模式中只会存在于创建它的节点中。

创建队列的节点称为该队列的主节点, 备份到的其它节点称为该队列的镜像节点。一个队列的主节点可能是另一个队列的镜像节点。主节点宕机后, 镜像节点会替代成为新的主节点。

缺点: 主节点的数据还没同步完成就宕机的话, 数据还是会丢失, 但是这种情况比较少见。

## 仲裁队列

仲裁队列(Quorum Queue): RabbitMQ 3.8 版本之后添加, 用于替代镜像队列。

仲裁队列基于 Raft 一致性协议实现，在仲裁队列中，消息需要得到集群中多数节点的同意确认后，才会被写入到队列中。这种机制确保了即使在部分节点发生故障的情况下，消息也不会丢失。
