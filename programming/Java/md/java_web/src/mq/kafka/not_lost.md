# 如何保证消息不丢失

消息丢失的情况:

1. 生产者发送到 brocker 时丢失
2. 消息在 brocker 中丢失
3. 消费者消费时丢失

## 生产者保证不丢失

1. 异步发送. 失败时记录日志
2. 发送失败重试

## brocker 保证不丢失

1. 使用发送确认机制 acks
   - acks = 0: 生产者不会等待服务器的确认
   - acks = 1: 默认, 只要集群的 leader 节点接收到消息, 就会给生产者发送确认
   - acks = all: 集群中所有节点全部收到消息后, 才会给生产者发送确认

## 消费者保证不丢失

kafka 会将一个 topic 分成多个不同的分区, 分区中的消息只能由同一个消费者组的其中一个消费者处理, 不同的分区会分配给消费者组内不同的消费者。

分区内有自己的偏移量, 用来标记消费到哪个消息了。每个消费者都有一个消费者偏移量, 用来标记自己消费到哪个消息了。

消费者默认每隔 5 秒向分区提交一次自己的消费者偏移量。

假设分区 2 绑定消费者 2。如果消费者 2 接收第 5 条消息并提交偏移量为 5, 而此时它还没消费第 5 条消息就宕机了。分区 2 会重新绑定到其它消费者上, 偏移量是 5, 那第 5 条消息就丢失了。

解决方案: 改为手动提交偏移量。
