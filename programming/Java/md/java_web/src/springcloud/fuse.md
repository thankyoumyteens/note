# 熔断

服务雪崩: 在微服务系统中, 整个系统是以一系列的微服务组成, 如果某一个服务不可用, 导致响应异常, 那么同样的也会影响到调用该服务的其他服务, 从而引起了一系列连锁反应, 最终导致整个系统崩溃。

假设有如下调用链:

```
ServiceA -> ServiceB -> ServiceC
```

如果 ServiceA 的流量突然增加, ServiceC 因为抗不住请求, 变得不可用。那么 ServiceB 的请求被会阻塞(等待 ServiceC 的响应), 随着请求不断增加慢慢耗尽 ServiceB 的线程资源, ServiceB 就会变得不可用。同理, ServiceA 也会不可用。

解决方案: 服务熔断和服务降级。服务熔断属于降级方式的一种。

## 服务降级

降级就是为服务提供了一个托底方案, 一旦服务无法正常调用, 就使用托底方案。

- 当下游的服务因为某种原因响应过慢, 下游服务主动停掉一些不太重要的业务, 释放出服务器资源, 增加响应速度
- 当下游的服务因为某种原因不可用, 上游主动调用本地的一些降级逻辑(比如返回错误提示), 避免卡顿, 迅速返回给用户

## 服务熔断

当下游的服务因为某种原因突然变得不可用或响应过慢, 上游服务为了保证自己整体服务的可用性, 不再继续调用目标服务, 直接返回, 快速释放资源。如果目标服务情况好转则恢复调用。这种牺牲局部, 保护整体的措施就叫做熔断。

hystrix 熔断机制:

```conf
# 熔断触发的最小个数, 即在一定的时间窗口内请求达到一定的次数, 默认20
hystrix.command.default.circuitBreaker.requestVolumeThreshold=20
# 时间窗口, 默认10s
hystrix.command.default.metrics.rollingStats.timeInMilliseconds=10000
# 失败率达到多少百分比后熔断 默认值: 50
hystrix.command.default.circuitBreaker.errorThresholdPercentage=50
# 熔断多长时间后, 尝试放一次请求进来, 默认5秒
hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds=5000
```

10 秒内的 20 个请求中, 失败率达到 50% 的时候, 熔断器就会打开, 此时再调用此服务, 将会直接返回失败, 不再调远程服务。在熔断开启 5 秒后, 允许一次请求(即此时熔断为半开状态), 如果请求访问成功则关闭熔断, 恢复正常调用, 否则继续熔断 5 秒, 以此循环。

熔断器的三个状态: 

1. 关闭状态: 关闭状态时客户端的请求是可以正常到达的
2. 开启状态: 开启状态时客户端的请求是不会到达服务端, 直接走降级方法
3. 半开状态: 当状态为开启时, 一定时间后, 熔断器就会由开启状态变成半开状态。这时候是可以接收客户端的一次请求, 如果请求成功则熔断器状态变为关闭, 如果请求失败则熔断器的状态变为开启状态, 等待下一个时间周期继续尝试服务调用
