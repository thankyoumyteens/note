# Redis

## Redis 持久化方式

- RDB 用数据集快照的方式半持久化模式记录 redis 数据库的所有键值对,在某个时间点将数据写入一个临时文件，持久化结束后，用这个临时文件替换上次持久化的文件，达到数据恢复
  - 优点：只有一个文件 dump.rdb ，方便持久化。容灾性好，一个文件可以保存到安全的磁盘。性能最大化，fork 子进程来完成写操作，让主进程继续处理命令，所以是 IO 最大化。使用单独子进程来进行持久化，主进程不会进行任何 IO 操作，保证了 Redis 的高性能。相对于数据集大时，比 AOF 的启动效率更高。
  - 缺点：数据安全性低。 RDB 是间隔一段时间进行持久化，如果持久化之间 Redis 发生故障，会发生数据丢失。所以这种方式更适合数据要求不严谨的时候
- AOF 指所有的命令行记录以 Redis 命令请求协议的格式完全持久化存储，保存为 AOF 文件
  - 优点：数据安全， AOF 持久化可以配置, 使每进行一次命令操作就记录到 AOF 文件中一次。通过 append 模式写文件，即使中途服务器宕机，可以通过 redis-check-aof 工具解决数据一致性问题。AOF 机制有 rewrite 模式, AOF 文件没被 rewrite 之前(文件过大时会对命令进行合并重写)，可以删除其中的某些命令(比如误操作的 flushall)
  - 缺点：AOF 文件比 RDB 文件大，且恢复速度慢。数据集大的时候，比 RDB 启动效率低。

## 排名功能要用 redis 的哪个数据类型

在实现排名功能时，Redis 中的有序集合（Sorted Set，也称为 ZSet）是最合适的数据类型

有序集合的特性:

- 成员唯一：有序集合中的每个成员都是唯一的，不会出现重复的成员
- 分数排序：每个成员都关联着一个分数（score），Redis 会根据这些分数对成员进行从小到大的排序。当分数相同时，会按照成员的字典序进行排序
- 高效操作：支持对成员的添加、删除、修改分数等操作，并且可以根据分数范围或排名范围快速获取成员

```sh
# 添加成员及分数
ZADD game_ranking 100 "player1" 200 "player2" 150 "player3"
# 获取玩家 "player2" 的排名
ZREVRANK game_ranking "player2"
# 获取排名范围内的成员, 获取排名前 3 的玩家
ZREVRANGE game_ranking 0 2 WITHSCORES
# 将玩家 "player1" 的分数增加 50
ZINCRBY game_ranking 50 "player1"
```

## Redis 支持事务吗

Redis 中的事务是一组命令的集合，是 Redis 的最小执行单位。它可以保证一次执行多个命令，每个事务是一个单独的隔离操作，事务中的所有命令都会序列化、按顺序地执行。服务端在执行事务的过程中，不会被其他客户端发送来的命令请求打断。它的原理是先将属于一个事务的命令发送给 Redis，然后依次执行这些命令。

需要注意的点:

Redis 事务是不支持回滚的，不像 MySQL 的事务一样，要么都执行要么都不执行。Redis 服务端在执行事务的过程中，不会被其他客户端发送来的命令请求打断。直到事务命令全部执行完毕才会执行其他客户端的命令。

使用场景

- 银行转账：在银行转账的场景中，需要从一个账户扣除一定金额，然后将该金额添加到另一个账户中。这两个操作必须作为一个原子操作执行，以确保资金的安全性和一致性。可以使用 Redis 事务来实现，将扣除金额和添加金额的命令放在一个事务中，保证要么两个操作都成功，要么都失败
- 购物车结算：在电商应用的购物车结算过程中，需要同时更新商品库存、生成订单、扣除用户余额等操作。使用 Redis 事务可以确保这些操作在一个原子操作中完成，避免出现部分操作成功，部分操作失败的情况，从而保证数据的一致性

相关命令:

- MULTI：用于开启一个事务，它将后续的命令放入一个队列中，等待执行
- EXEC：用于执行事务中所有已经入队的命令。当执行 EXEC 命令时，Redis 会按照顺序依次执行队列中的命令，并将结果返回给客户端
- DISCARD：用于取消事务，它会清空事务队列中所有已经入队的命令，并且释放事务执行过程中占用的资源
- WATCH：用于监视一个或多个键，在执行事务之前，如果被监视的键被其他客户端修改，那么事务将被中断，不会执行。可以通过 UNWATCH 命令来取消对所有键的监视

## Redis 为什么设计成单线程的

多线程处理会涉及到锁，并且多线程处理会涉及到线程切换而消耗 CPU。采用单线程，避免了不必要的上下文切换和竞争条件。其次 CPU 不是 Redis 的瓶颈，Redis 的瓶颈最有可能是机器内存或者网络带宽。
