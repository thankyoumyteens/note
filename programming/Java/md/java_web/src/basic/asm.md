# 你说有 ASM 字节码增强的实践，具体是做什么？为什么不用 Spring AOP？

在 XX 项目里，我们曾经做过一个**统一的接口审计与性能统计组件**，最开始用的是 Spring AOP + 注解方式，后面遇到两个问题：

1. 有一部分是第三方 jar 包里的类，无法直接加注解或改代码；
2. AOP 在某些高调用频次的核心链路上，有一定性能开销，我们想要更细粒度地控制增强点。

所以后来尝试了基于 ASM 的字节码增强，主要做了两类事情：

1. 在类加载阶段对特定包下的方法进行字节码修改，注入「进入方法时间点、出方法时间点、异常捕获」等逻辑，然后把数据异步上报到监控系统；
2. 对接第三方 SDK 的入口方法进行增强，不需要修改原始源码，就能加入我们自己的 traceId 透传逻辑。

Spring AOP 更偏向于业务层面的横切关注点，而 ASM 直接操作字节码，虽然复杂一些，但能做到：

- 不依赖 Spring 容器；
- 可以增强第三方类；
- 在某些高性能场景下更精细地控制增强粒度。

当然，ASM 只用在少数关键场景，大部分业务层的横切还是用 Spring AOP 来做。
