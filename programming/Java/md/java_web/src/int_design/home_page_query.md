# APP 首页增加查询余额功能

首页一旦加「查余额」这种高成本接口，没设计好就很容易被打趴。

咱们一步一步拆一下，从产品交互、架构设计、性能优化几个层面来设计。

## 产品交互：是不是必须「首屏就实时查余额」？

很多时候，可以通过交互设计降低请求量，比一味抗压更有效：

1. 改为点击后加载
   - 首页只展示一个「查看余额」入口（按钮/卡片），用户点击后再发请求。
   - 优点：
     - 避免每次打开首页就查一次余额。
     - 请求量与「点按钮的人」挂钩，而不是所有启动首页的人。
     - 如果业务有硬需求「打开首页就要看到余额」，可以考虑下面的方式。
2. 按需/延迟加载（Lazy Load）
   - 首页加载时先不查余额，等页面稳定后（比如 1~2 秒）再在后台请求余额。
   - 优点：
     - 高峰期首页 QPS 被摊开，不是瞬间洪峰。
     - 用户视觉上感觉首页很快打开，余额稍后出现，也比较可接受。
3. 增加刷新/手动更新
   - 展示缓存余额，上面给一个「刷新余额」按钮，只有用户主动刷新时才走实时接口。
   - 适合余额不是「强一致」要求的场景（比如积分、优惠金等）。

如果产品愿意做妥协，上面这几个就已经能砍掉大部分无谓压力。

## 架构设计

### 接口层面的防护与限流策略

#### 1. 网关层限流（熔断+降级）

1. 在 API Gateway / Nginx / Zuul 等入口层：
   - 按 IP / 用户 ID / 设备 ID 限流，比如对「查询余额」接口设置：
     - 单用户：每分钟最多 5~10 次
     - 单 IP：每秒最多 X 次
2. 全局 QPS 限流
   - 给接口设定一个总体 QPS 上限，比如 2000 QPS。
   - 超过直接返回「系统繁忙，请稍后再试」，前端做兜底提示。
3. 熔断机制
   - 一旦下游（余额服务或数据库）响应过慢/超时率飙升，主动熔断，快速失败。
   - 优点：保护核心系统不被拖垮，而不是一起“陪葬”。

#### 2. 降级策略设计

当压力过大时，可以有不同等级的降级方案：

1. 停实时，走缓存
   - 比如优先返回最近 X 分钟内的余额快照，并在页面上标注「数据更新于 10:23」。
   - 对大多数场景来说，这是可以接受的妥协。
2. 只允许部分用户查
   - 例如只允许登录态、且某些 VIP 用户实时查，普通用户看到的是缓存或提示稍后再试。
3. 彻底提示不可用
   - 接口被限流或熔断时，直接返回带错误码的统一错误，前端给出友好文案：
   - 「当前查询人数较多，暂时无法获取最新余额，请稍后重试。」

### 后端架构与数据层设计

关键在于：尽量减少直打数据库 + 单点热点。

#### 1. 加缓存层

设计思路：

- 用户余额数据通常在某段时间内变化频率有限（除非是高频交易系统）。
- 可以在缓存中维护余额，减少对数据库的直接查询。

#### 2. 数据库侧优化

如果查余额仍需要部分 DB 操作

1. 单表别成热点
   - 根据用户 ID 合理分库分表。
   - 有用户 ID 索引，避免全表扫描。
2. 读写分离
   - 写走主库，读走只读库。
   - 查询余额走从库，减轻主库压力。
3. 短查询 + 限制字段
   - 查询语句只查必要字段（用户 ID、余额），不要 `SELECT *`。

## 灰度发布

新增首页余额功能时，先只对一部分用户开放（比如 5%），观察 QPS、错误率、响应时间，再逐步放量。

## 预估容量 & 压测

在上线前做压测：

- 比如首页预计 1 万 QPS，其中有 30% 会请求余额，则余额接口目标承载 >= 3000 QPS。

通过压测调整 Redis 规模、数据库连接池大小、限流阈值。
