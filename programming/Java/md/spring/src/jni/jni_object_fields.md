# 访问的对象字段

1. 创建 `src/main/java/org/example/jnidemo/TestJNIInstanceVariable.java` 文件:

```java
package org.example.jnidemo;

public class TestJNIInstanceVariable {
    static {
        System.loadLibrary("myjni");
    }

    // 字段
    private int number = 88;
    private String message = "Hello from Java";

    // Declare a native method that modifies the instance variables
    private native void modifyInstanceVariable();

    // Test Driver
    public static void main(String[] args) {
        TestJNIInstanceVariable test = new TestJNIInstanceVariable();
        test.modifyInstanceVariable();
        System.out.println("In Java, int is " + test.number);
        System.out.println("In Java, String is " + test.message);
    }
}
```

2. 编译并生成头文件:

```sh
cd src/main/java/org/example/jnidemo
# . 表示在当前目录下生成, 可以指定其它目录
javac -h . TestJNIInstanceVariable.java
```

目录下会新增 `org_example_jnidemo_TestJNIInstanceVariable.h` 文件

头文件内容如下:

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class org_example_jnidemo_TestJNIInstanceVariable */

#ifndef _Included_org_example_jnidemo_TestJNIInstanceVariable
#define _Included_org_example_jnidemo_TestJNIInstanceVariable
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     org_example_jnidemo_TestJNIInstanceVariable
 * Method:    modifyInstanceVariable
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_org_example_jnidemo_TestJNIInstanceVariable_modifyInstanceVariable
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

3. 创建 `src/main/java/org/example/jnidemo/TestJNIInstanceVariable.cpp` 文件:

```cpp
#include <jni.h>
#include <stdio.h>
#include "org_example_jnidemo_TestJNIInstanceVariable.h"

JNIEXPORT void JNICALL Java_org_example_jnidemo_TestJNIInstanceVariable_modifyInstanceVariable
          (JNIEnv *env, jobject thisObj) {
   // 获取对象的Class
   jclass thisClass = env->GetObjectClass(thisObj);

   // 获取number字段的id
   jfieldID fidNumber = env->GetFieldID(thisClass, "number", "I");
   if (NULL == fidNumber) return;

   // 根据字段id从对象中获取字段的值
   jint number = env->GetIntField(thisObj, fidNumber);
   printf("In C, the int is %d\n", number);

   // 修改字段的值
   number = 99;
   // 根据字段id修改对象中字段的值
   env->SetIntField(thisObj, fidNumber, number);

   // 获取message字段的id
   jfieldID fidMessage = env->GetFieldID(thisClass, "message", "Ljava/lang/String;");
   if (NULL == fidMessage) return;

   // 根据字段id从对象中获取字段的值
   // 返回值是jobject, 需要转成jstring
   jstring message = (jstring) env->GetObjectField(thisObj, fidMessage);

   // java字符串转char数组
   const char *cStr = env->GetStringUTFChars(message, NULL);
   if (NULL == cStr) return;

   // 输出message的内容
   printf("In C, the string is %s\n", cStr);
   env->ReleaseStringUTFChars(message, cStr);

   // 创建新的java字符串
   message = env->NewStringUTF("Hello from C");
   if (NULL == message) return;

   // 替换message的值
   env->SetObjectField(thisObj, fidMessage, message);
}
```

4. 编译 c++ 代码:

```sh
g++ -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/darwin" -dynamiclib -o libmyjni.dylib TestJNIInstanceVariable.cpp
```

5. 运行 java

```sh
cd ../../../
java -Djava.library.path=org/example/jnidemo  org.example.jnidemo.TestJNIInstanceVariable
```
