# 主从复制

Redis 主从复制是 Redis 提供的一种数据冗余方案, 用于提高数据的可靠性和可扩展性。在主从复制架构中, 有一个 Redis 服务器实例作为主节点（master）, 一个或多个 Redis 服务器实例作为从节点（slave）。数据的写入操作在主节点上执行, 而读操作可以在从节点上执行, 这样可以分散读请求, 提高系统的性能。

## Redis 设置主从结构的三种方式

Redis 5.0 之后, `slaveof` 命令被 `replicaof` 命令替换。

- 在 `redis.conf` 中配置 `replicaof <masterip> <masterport>`, Redis 启动后将成为实例`<masterip>:<masterport>`的从节点
- 在 `redis-server` 启动参数中增加 `--replicaof <masterip> <masterport>` 参数
- 使用 `redis-cli` 连接到 redis 服务, 执行 `replicaof <masterip> <masterport>` 命令。使用这种方式, 如果 Redis 重启, 主从关系将无法重新建立。

## 主从节点同步的流程

### sync 命令

旧版本 redis 的主从同步使用的是 sync 命令全量主从复制。

1. 当从节点首次连接或断开重连后, 会向主节点发送 `sync` 命令开始主从同步
2. 主节点收到 `sync` 命令后会通过 `bgsave` 命令开始在后台保存 RDB 快照, 并将保存快照期间接收到的新命令缓存起来
3. 主节点执行 RDB 持久化完成后, 向从节点发送 RDB 文件, 并在发送快照期间继续记录被执行的写命令
4. 从节点收到 RDB 文件后清空所有数据, 并载入收到的 RDB 文件
5. 主节点 RDB 发送完毕, 且从节点载入快照完毕后, 主节点开始向从节点发送缓冲区中的写命令
6. 主节点完成对快照的载入, 开始接收命令请求, 并执行来自主数据库缓冲区的写命令
7. 当完成同步操作之后, 主从节点便会进入命令传播阶段: 主节点继续接收和执行写命令, 并将这些写命令实时发送给所有从节点。从节点接收这些命令并执行, 以保持数据与主节点一致

`sync` 命令存在的缺陷: 不管从节点是第一次启动, 还是连接断开后的重连, 主从同步都是全量数据复制, 严重消耗主节点的资源以及大量的网络连接资源。

Redis 在 2.8 及以上版本使用 `psync` 命令完成主从数据同步, `psync` 命令的同步过程分为全量同步和部分同步, 解决了`sync` 命令存在的缺陷。

### psync 命令

`psync` 的实现依赖于主从双方共同维护的 replid 和 offset。

replid: 每个 Redis 节点在成为主节点时, 都会生成的随机字符串。从节点连接到主节点后, 会把自己存储的 replid 发送给主节点, 主节点会比较这个 replid 和自己的是否一致, 如果不一致, 则表示这个从节点是首次同步, 主节点就会把自己的 replid 发送给从节点保存。

offset: 它用于跟踪同步过程中的进度。如果从节点中记录的 offset 为 10, 主节点中记录的 offset 为 20, 那么在同步的时候, 主节点会把 backlog 中偏移量为 10 到 20 的命令发送给从节点。

1. 从节点与主节点建立连接后, 需要从节点使用命令 `PSYNC <replid> <offset>` 向主节点发起同步请求, 如果该从节点是首次连接某个主节点, 那么会使用特殊的命令 `PSYNC ? -1`
2. 主节点接收到命令, 解析请求中的 replid 和 offset, 然后去判断当前请求是否可以使用部分同步:
   - 从节点的 replid 与主节点的 replid 一致
   - 从节点的 offset 必须在主节点的 backlog_off 和 offset 的范围之间
3. 不满足部分同步条件的话, 就会使用全量同步, 全量同步和 `sync` 命令的类似
4. 当完成同步操作之后, 主从节点便会进入命令传播阶段, 当主节点执行完新的写命令后, 会把该命令追加到缓冲区, 然后异步地发送给从节点。从节点接收命令并执行, 同时更新从节点自己维护的 offset
5. 在命令传播阶段, 每隔一秒, 从节点向主节点发送一次心跳信息, 命令格式为 `REPLCONF ACK <offset>`
6. 主节点接收后便会与自己的 offset 对比。如果从节点数据缺失, 主节点会推送缺失的数据
