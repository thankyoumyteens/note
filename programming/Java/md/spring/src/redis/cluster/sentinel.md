# 哨兵

Redis Sentinel（哨兵）是 Redis 的一个高可用性解决方案, 它的作用主要包括以下几点: 

1. Sentinel 会不断地监控 Redis 主节点和从节点的健康状态, 确保它们正常运行。

2. Sentinel 可以配置为在检测到问题时发送通知, 例如通过电子邮件或其他方式通知系统管理员。

3. 当主节点发生故障时, Sentinel 能够自动进行故障转移。它会选举出一个从节点作为新的主节点, 并更新其他从节点的配置, 让它们开始复制新的主节点。

4. 在主节点故障转移后, Sentinel 可以为客户端提供新的主节点的配置信息, 帮助客户端自动重新连接到新的主节点。

Redis Sentinel 通过这些功能提供了一种相对简单的方式来实现 Redis 的高可用性。然而, Sentinel 也有一些局限性, 例如它不支持自动的数据分片和水平扩展, 这些功能在 Redis Cluster 中提供。对于需要更高级的集群管理功能的场景, Redis Cluster 可能是一个更好的选择。

## 服务状态监控

Sentinel 基于心跳机制检测服务状态, 每隔 1 秒向集群的每个实例发送 ping 命令。如果一个实例在 down-after-milliseconds 配置的时间范围内没有响应或者响应无效, Sentinel 会将该实例标记为主观下线。

当一个主节点被一个 Sentinel 标记为主观下线时, Sentinel 会询问其他 Sentinel 对该主节点状态的看法。如果足够数量的 Sentinel（超过配置的 quorum 数量）同意该主节点已经下线, 那么该主节点会被标记为客观下线。

一旦主节点被标记为客观下线, Sentinel 会触发故障转移过程:

1. 选择一个从节点提升为新的主节点。
2. 让剩余的从节点开始复制新的主节点。
3. 将旧的主节点配置为新主节点的从节点, 等待它重新上线。

## 哨兵选择主节点的规则

Redis Sentinel 选择新的主节点的工作不需要所有的哨兵都参与, 只需要选出个代表（称为 leader）, 由 leader 负责进行 slave 提升到 master 的过程。这个选举的过程涉及到 Raft 算法。

leader 选择新的主节点的规则: 

1. 优先级最高的从节点胜出。每个 redis 节点都会在配置文件中有一个优先级配置（slave-priority, 默认情况下都相同）
2. offset 最大的从节点胜出。offset 代表从节点从主节点这里同步数据的进度。数值越大, 说明从节点的数据和主节点就越接近
3. run id 值更小的胜出。run id 是每个 redis 节点启动的时候随机生成的一串数字。此时意味着优先级和 offset 都一样, 那么选谁都可以, 其实就是随便挑一个

## 脑裂问题

脑裂（Split-brain）是指在主从集群中, 同时有两个主节点, 它们都能接收写请求。

例如, 当前的主节点突然网络不稳定, 导致哨兵暂时无法与之通信, 此时监听的哨兵会自动启动主从切换机制。当这个原来的主节点恢复网络后, 哨兵已经选出了新的主节点, 这样一来, 旧的主节点和新主节点就会同时存在。此时所有的从节点都会指向新的主节点, 旧的主节点在失联期间处理的客户端请求就会丢失。

## 解决脑裂问题

Redis 中可以使用两个配置项解决这个问题: min-slaves-to-write（最小从服务器数）和 min-slaves-max-lag（从连接的最大延迟时间）。

- min-slaves-to-write（最小从服务器数）: 指主节点最少得有 n 个健康的从节点存活才能执行写命令。这个配置可以避免当没有足够的从节点时, 主节点无法正常写入, 以此来避免数据的丢失
- min-slaves-max-lag（从连接的最大延迟时间）: 是指主从节点进行数据复制时的延迟不能超过指定的时间

这样一来, 当原来的主节点无法和哨兵以及从节点通信时, 此时的 min-slaves-to-write 和 min-slaves-max-lag 的组合要求就无法得到满足, 客户端就不能向原来的主节点中写入新数据, 就可以避免数据丢失。
