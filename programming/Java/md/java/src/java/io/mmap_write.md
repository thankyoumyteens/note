# mmap+write 实现零拷贝

mmap 是 Linux 提供的一种内存映射文件方法，它可以将一个文件或者其它对象映射到进程的地址空间，实现文件磁盘地址和进程虚拟地址空间中一段虚拟地址的一一对映关系。实现这样的映射关系后，进程就可以采用指针的方式读写操作这一段内存，而系统会自动回写脏页面到对应的文件磁盘上，即完成了对文件的操作而不必再调用 read,write 等系统调用函数。相反，内核空间对这段区域的修改也直接反映用户空间，从而可以实现不同进程间的文件共享。

基于 mmap + write 系统调用的零拷贝方式，整个拷贝过程会发生 4 次上下文切换，3 次拷贝，流程如下:

1. 用户进程通过 `mmap()` 函数向内核发起系统调用，上下文从用户态切换为内核态
2. `mmap()` 将内核空间的读缓冲区与一部分用户缓冲区进行内存地址映射
3. CPU 利用 DMA 控制器将数据从主存或硬盘拷贝到内核的读缓冲区
4. 上下文从内核态切换回用户态，mmap 系统调用返回
5. 用户进程通过 `write()` 函数向内核发起系统调用，上下文从用户态切换为内核态
6. CPU 将内核读缓冲区中的数据拷贝到内核写缓冲区
7. CPU 利用 DMA 控制器将数据从写缓冲区拷贝到磁盘
8. 上下文从内核态切换回用户态，write 系统调用返回
