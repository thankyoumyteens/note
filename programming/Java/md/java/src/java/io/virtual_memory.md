# 虚拟内存

虚拟内存使得应用程序认为它拥有连续的可用的内存(一个连续完整的地址空间)。而实际上, 虚拟内存通常是被分成多个物理内存碎片, 还有部分暂时存储在外部磁盘上, 在需要时进行数据交换, 加载到物理内存中。

一般来说不同进程里的同一个虚拟内存地址指向的物理地址是不一样的。每个进程所能使用的虚拟地址大小和 CPU 位数有关。在 32 位的系统上, 虚拟地址空间大小是 2 ^ 32 = 4GB, 在 64 位系统上, 虚拟地址空间大小是 2 ^ 64= 16,777,216TB, 而实际的物理内存可能远小于虚拟内存。

每个用户进程维护了一个单独的页表(Page Table), 虚拟内存和物理内存就是通过这个页表实现地址空间的映射的。页表里面的数据由操作系统维护。页表里面的每个内存映射(Memory Mapping)都将一块虚拟地址映射到一个特定的地址空间(物理内存或者磁盘存储空间)。

进程申请并访问物理内存的过程：

1. 用户进程向操作系统发出内存申请请求
2. 系统会检查进程的虚拟地址空间是否被用完, 如果有剩余, 给进程分配虚拟地址
3. 系统为这块虚拟地址创建的内存映射, 并将它放进该进程的页表
4. 系统返回虚拟地址给用户进程, 用户进程开始访问该虚拟地址
5. CPU 根据虚拟地址在此进程的页表中找到相应的内存映射, 但是这个内存映射没有和物理内存关联, 于是产生缺页中断
6. 操作系统收到缺页中断后, 分配真正的物理内存并将它关联到页表相应的内存映射。中断处理完成后 CPU 就可以访问内存了
7. 缺页中断不是每次都会发生, 只有系统觉得有必要延迟分配内存的时候才用, 很多时候在第 3 步系统会分配真正的物理内存并和内存映射进行关联
