# 内核空间和用户空间

操作系统内核独立于普通的应用程序, 可以访问受保护的内存空间, 也有访问底层硬件设备的权限。为了避免用户进程直接操作内核, 保证内核安全, 操作系统将虚拟内存划分为两部分, 一部分是内核空间(Kernel-space), 一部分是用户空间(User-space)。内核模块运行在内核空间, 对应的进程处于内核态。而用户程序运行在用户空间, 对应的进程处于用户态。

内核空间和用户空间所占的虚拟内存比例是 1:3, 32 位 Linux 系统的寻址空间(虚拟存储空间)为 4GB, 将最高位的 1GB 的字节(虚拟地址 `0xFFFFFFFF` 到 `0xC0000000`)供内核进程使用, 称为内核空间。而低位的 3GB 的字节(虚拟地址 `0xBFFFFFFF` 到 `0x00000000`), 供用户进程使用, 称为用户空间。64 Linux 系统仅使用低 47 位地址, 高 17 位做扩展(只能是全 0 或全 1), 所以内核空间地址范围是 `0xFFFFFFFFFFFFFFFF` 到 `0xFFFF800000000000`, 用户空间地址范围是 `0x00007FFFFFFFFFFF` 到 `0x0000000000000000`, 。

## 内核空间

内核空间总是驻留在内存中, 它是为操作系统的内核保留的。应用程序是不允许直接在该区域进行读写或直接调用内核代码定义的函数的。上图左侧区域为内核进程对应的虚拟内存, 按访问权限可以分为每个进程私有和进程共享两块区域。

- 进程私有的虚拟内存：每个进程都有单独的内核栈、页表、task 结构以及 mem_map 结构等
- 进程共享的虚拟内存：属于所有进程共享的内存区域, 包括物理存储器、内核数据和内核代码区域

## 用户空间

每个普通的用户进程都有一个单独的用户空间, 处于用户态的进程不能访问内核空间中的数据, 也不能直接调用内核函数的 , 因此要进行系统调用的时候, 就要将进程切换到内核态。

用户空间包括以下几个区域：

- 运行时栈：存放函数的参数, 局部变量和返回值等。每当一个函数被调用时, 该函数的调用信息被存储到栈顶, 调用结束后调用信息会被弹出并释放。栈是从高地址位向低地址位增长的, 是一块连续的内在区域, 最大容量是由系统预先定义好的, 申请的栈空间超过这个界限时会提示溢出, 用户能从栈中获取的空间较小
- 运行时堆：用于存放进程运行中被动态分配的内存段, 位于 BSS 段和栈中间的地址。由开发人员申请分配(比如 malloc 函数)和释放(比如 free 函数)。堆是从低地址位向高地址位增长, 采用链式存储结构。频繁地申请和释放造成堆内存空间的不连续, 产生大量碎片。当申请堆空间时, 库函数按照一定的算法搜索可用的足够大的空间。因此堆的效率比栈要低的多
- 代码段：存放 CPU 可以执行的机器指令, 该部分内存只能读不能写。通常代码区是共享的, 即其它执行程序可调用它。假如机器中有数个进程运行相同的一个程序, 那么它们就可以使用同一个代码段
- BSS 段：存放未初始化的全局变量, BSS 的数据在程序开始执行之前被初始化为 0 或 NULL
- 已初始化的数据段：存放已初始化的全局变量, 包括静态全局变量、静态局部变量以及常量
- 内存映射区域：例如将动态库, 共享内存等虚拟空间的内存映射到物理空间的内存, 一般是 mmap 函数所分配的虚拟内存空间
