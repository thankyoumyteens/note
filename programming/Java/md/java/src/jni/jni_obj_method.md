# 访问对象的方法

1. 创建 `src/main/java/org/example/jnidemo/TestJNICallBackMethod.java` 文件:

```java
package org.example.jnidemo;

public class TestJNICallBackMethod {
    static {
        System.loadLibrary("myjni");
    }

    // 在nativeMethod中会调用下面的3个callback方法
    private native void nativeMethod();

    private void callback() {
        System.out.println("In Java");
    }

    private void callback(String message) {
        System.out.println("In Java with " + message);
    }

    private double callbackAverage(int n1, int n2) {
        return ((double) n1 + n2) / 2.0;
    }

    public static void main(String[] args) {
        new TestJNICallBackMethod().nativeMethod();
    }
}
```

2. 编译并生成头文件:

```sh
cd src/main/java/org/example/jnidemo
# . 表示在当前目录下生成, 可以指定其它目录
javac -h . TestJNICallBackMethod.java
```

目录下会新增 `org_example_jnidemo_TestJNICallBackMethod.h` 文件

头文件内容如下:

```c
/* DO NOT EDIT THIS FILE - it is machine generated */
#include <jni.h>
/* Header for class org_example_jnidemo_TestJNICallBackMethod */

#ifndef _Included_org_example_jnidemo_TestJNICallBackMethod
#define _Included_org_example_jnidemo_TestJNICallBackMethod
#ifdef __cplusplus
extern "C" {
#endif
/*
 * Class:     org_example_jnidemo_TestJNICallBackMethod
 * Method:    nativeMethod
 * Signature: ()V
 */
JNIEXPORT void JNICALL Java_org_example_jnidemo_TestJNICallBackMethod_nativeMethod
  (JNIEnv *, jobject);

#ifdef __cplusplus
}
#endif
#endif
```

3. 创建 `src/main/java/org/example/jnidemo/TestJNICallBackMethod.cpp` 文件:

```cpp
#include <jni.h>
#include <stdio.h>
#include "org_example_jnidemo_TestJNICallBackMethod.h"

JNIEXPORT void JNICALL Java_org_example_jnidemo_TestJNICallBackMethod_nativeMethod
          (JNIEnv *env, jobject thisObj) {

   // 获取对象的Class
   jclass thisClass = env->GetObjectClass(thisObj);

   // 获取void callback()方法的id
   jmethodID midCallBack = env->GetMethodID(thisClass, "callback", "()V");
   if (NULL == midCallBack) return;
   printf("In C, call back Java's callback()\n");
   // 执行callback方法
   env->CallVoidMethod(thisObj, midCallBack);

   // 获取void callback(String message)方法的id
   jmethodID midCallBackStr = env->GetMethodID(thisClass,
                               "callback", "(Ljava/lang/String;)V");
   if (NULL == midCallBackStr) return;
   printf("In C, call back Java's called(String)\n");
   // callback方法的入参
   jstring message = env->NewStringUTF("Hello from C");
   // 执行callback方法
   env->CallVoidMethod(thisObj, midCallBackStr, message);

   // 获取double callbackAverage(int n1, int n2)方法的id
   jmethodID midCallBackAverage = env->GetMethodID(thisClass,
                                  "callbackAverage", "(II)D");
   if (NULL == midCallBackAverage) return;
   // 执行callback方法, 并获取返回值
   jdouble average = env->CallDoubleMethod(thisObj, midCallBackAverage, 2, 3);
   printf("In C, the average is %f\n", average);

}
```

4. 编译 c++ 代码:

```sh
g++ -I"$JAVA_HOME/include" -I"$JAVA_HOME/include/darwin" -dynamiclib -o libmyjni.dylib TestJNICallBackMethod.cpp
```

5. 运行 java

```sh
cd ../../../
java -Djava.library.path=org/example/jnidemo  org.example.jnidemo.TestJNICallBackMethod
```
