# NUMA

非统一内存访问架构(non-uniform memory access, NUMA), 是一种为多处理器的电脑设计的内存架构, 内存访问时间取决于内存相对于 CPU 的位置。

## SMP

## NUMA

在多核 CPU 系统中, 所有的核心共享同一块内存, 当多个核心同时访问内存时, 就会产生争用, 这种争用会导致内存访问的延迟增加, 从而影响系统的整体性能。NUMA 就是为了解决这个问题。在 NUMA 中, 每个节点都有自己的内存, 节点之间通过 CPU 互连网络进行通信。这样, 每个节点中的 CPU 访问自己的内存时, 就不会与其他节点产生争用, 从而减少了内存访问的延迟, 提高了系统的整体性能。

## G1 的 NUMA 支持

现代的多插槽服务器越来越多的使用 NUMA 架构, 这表示内存到每个 socket(socket 就是主板上插 cpu 的槽) 的距离是不相等的, 内存到不同的 socket 之间的访问是有性能差异的, 访问的 socket 距离越远, 性能就会越差。ParallelGC 很多年前就已经支持 NUMA 了, 但 G1 直到 JDK 14 才支持 NUMA。

[JEP345](https://openjdk.org/jeps/345)在 JDK 14 的 G1 中增加了对 NUMA 的支持。在分配内存的过程中, 如果支持了 NUMA, G1 会优先在与当前线程所绑定的 NUMA 节点的空闲内存区域来分配内存空间。在新生代 region 中, 同一线程创建的对象会尽可能的分配到同一 NUMA 节点上, 因为是基于同一个线程创建的对象大部分是短存活并且高概率互相调用的。

如果要启用 NUMA, 可以在 JVM 参数中加上: -XX:+UseNUMA。
