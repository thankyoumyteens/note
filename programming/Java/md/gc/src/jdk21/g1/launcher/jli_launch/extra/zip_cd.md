# zip 文件的中央目录

所有文件组成的 Entry 存储完毕后会生成 中央目录文件头(Central Directory File Header), 每个 Entry 都会对应一个 Central Directory File Header。

所有的 Central Directory File Header 结束后会添加一个 中央目录结束记录(End Of Central Directory Record, EOCD), 每个 ZIP 文件只有一个 EOCD。

```
[Entry1]
[Entry2]
[Entry3]
...
[Central Directory File Header 1]
[Central Directory File Header 2]
[Central Directory File Header 3]
...
[End Of Central Directory Record]
```

## Central Directory File Header

每个 Entry 都有一个 Central Directory File Header，Central Directory File Header 中的大部分信息都和 Local File Header（或者 data descriptor）中的信息是重复的，然后就是 Entry 的定位信息，主要就是为了根据中央目录快速定位 Entry，而不用读取完整的整个文件去查找某个文件，相当于索引。

| 偏移量(offset) | 长度(字节) | 描述                                                                                                                                             |
| -------------- | ---------- | ------------------------------------------------------------------------------------------------------------------------------------------------ |
| 0              | 4          | 签名，固定值: 0x02014b50                                                                                                                         |
| 4              | 2          | 使用哪个 ZIP 版本压缩的                                                                                                                          |
| 6              | 2          | 解析该目录需要的最低版本号，与对应 Entry 的 Local File Header 中的值一致                                                                         |
| 8              | 2          | 一般标志位，与对应 Entry 的 Local File Header 中的值一致                                                                                         |
| 10             | 2          | 压缩方法，与对应 Entry 的 Local File Header 中的值一致                                                                                           |
| 12             | 2          | 文件最后修改时间，与对应 Entry 的 Local File Header 中的值一致                                                                                   |
| 14             | 2          | 文件最后修改日期，与对应 Entry 的 Local File Header 中的值一致                                                                                   |
| 16             | 4          | 文件压缩前的 CRC-32                                                                                                                              |
| 20             | 4          | 文件压缩后大小, 4 个字节, 限制了压缩后的单个文件最大只能到 4GB - 1                                                                               |
| 24             | 4          | 文件压缩前大小, 4 个字节, 限制了压缩前的单个文件最大只能到 4GB - 1                                                                               |
| 28             | 2          | 文件名长度（n），与对应 Entry 的 Local File Header 中的值一致                                                                                    |
| 30             | 2          | 扩展字段长度（m），与对应 Entry 的 Local File Header 中的值可能不一致                                                                            |
| 32             | 2          | 文件备注长度（k）                                                                                                                                |
| 34             | 2          | 文件起始位置所在的磁盘编号（这个用于 zip 跨磁盘的场景，在早期磁盘是很小的，所以一个 zip 文件可能会跨多个磁盘，而现在基本不太可能出现这种场景了） |
| 36             | 2          | 内部文件属性                                                                                                                                     |
| 38             | 4          | 外部文件属性                                                                                                                                     |
| 42             | 4          | 本条目录指向的 Entry 相对于第一个 Entry 的起始位置, 4 个字节, 限制了 ZIP 文件最大是 4GB - 1，再大就无法定位了                                    |
| 46             | n          | 文件名                                                                                                                                           |
| 46+n           | m          | 扩展字段                                                                                                                                         |
| 46+n+m         | k          | 文件备注                                                                                                                                         |

## EOCD

标志 ZIP 文件结束，判断一个文件是否是 ZIP 格式的文件就是读取文件末尾的 EOCD 来判断，而不是像其他文件一样读取文件头来判断。

| 偏移量(offset) | 长度(字节) | 描述                                                                                                                                                                                                                                                                       |
| -------------- | ---------- | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 0              | 4          | 签名，固定值: 0x06054b50, 主要就是通过这个签名在 zip 中查找 EOCD                                                                                                                                                                                                           |
| 4              | 2          | 占用磁盘数                                                                                                                                                                                                                                                                 |
| 6              | 2          | 中央目录的起始位置所在的磁盘                                                                                                                                                                                                                                               |
| 8              | 2          | 当前磁盘上的中央目录记录数                                                                                                                                                                                                                                                 |
| 10             | 2          | 中央目录的总数量, 2 个字节, 这限制了一个 ZIP 文件中存储的文件数最多不能超过 65535 个                                                                                                                                                                                       |
| 12             | 4          | 中央目录的总大小                                                                                                                                                                                                                                                           |
| 16             | 4          | 中央目录相对于 ZIP 文件第一个 Entry 的起始位置(注意: 不是相对于 ZIP 文件的起始位置，这是一个细微的差别，在大多数场景下都是可以忽略的，但是如果 ZIP 文件头包含一些前缀数据，例如自解压程序时，这个起始位置是包含这些前缀数据的，而 zip 的第一个 Entry 是在这些前缀数据之后) |
| 20             | 2          | 备注长度                                                                                                                                                                                                                                                                   |
| 22             | n          | 备注, 长度最大是 65535 字节                                                                                                                                                                                                                                                |

## 寻找 EOCD 的步骤

整个 EOCD 结构的长度是:

```
最小长度：22 字节(无备注)
最大长度：22 + 65535 = 65557 字节(备注长度最大)
```

常规寻找方案:

1. 确定 ZIP 文件的总长度 fileSize
2. 从尾部往前最多扫描 `min(fileSize, 65557+一点余量)` 字节
3. 在这块区域里，从后往前搜索签名 `0x06054b50`
4. 找到签名后，再检查：
   1. 这个位置后面的结构是否足够长（至少 22 字节）
   2. 备注长度 字段是否与“到文件末尾的距离”匹配
5. 如果这些都对得上，就认为这里是 EOCD 的起始位置
