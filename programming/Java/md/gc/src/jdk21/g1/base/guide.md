# Garbage-First 垃圾回收器

## 简介

Garbage-First (G1) 垃圾回收器的目标是多处理器的大内存机器。它努力满足垃圾回收的目标暂停时间，同时在几乎不需要配置的情况下实现高吞吐量。G1 的目标是运行在以下类型的应用程序中时, 在延迟和吞吐量之间找到最好的平衡:

- 堆的大小是数十 GB 或更高, 并且 Java 堆的空间中有超过 50% 的存活对象
- 对象分配和晋升的比率可能会随时间显著变化
- 堆中存在大量碎片
- 可预测的暂停时间目标目标不超过几百毫秒，避免长时间的垃圾回收暂停

G1 在应用程序运行的同时执行其部分工作。它交换了本应可供应用程序使用的处理器资源，以换取更短的收集暂停时间。

这在应用程序运行时使用一个或多个处于活动状态的垃圾回收线程时最为明显。因此，与吞吐量回收器相比，虽然 G1 的暂停时间通常要短得多，但应用程序吞吐量也往往更低一些。

G1 是 JDK21 默认的垃圾回收器。

G1 收集器实现了高性能，并通过以下几节中描述的几种方式尽力满足暂停时间目标。

## 启用 G1

Garbage-First 垃圾收集器是默认收集器，因此您通常不必执行任何额外操作。您可以通过在命令行上提供 `-XX:+UseG1GC` 显式启用它。

## 基本概念

G1 是分代的(generational)、增量的(incremental)、并行的(parallel)、大部分是并发的(concurrent)、暂停应用程序线程的(stop-the-world)和采用疏散方式(evacuating)进行垃圾回收的垃圾回收器, 它在每次 stop-the-world 都会监测暂停目标时间。和其它回收器类似, G1 把堆分成了(虚拟的)新生代和老年代。空间回收工作(space-reclamation)主要集中在新生代，因为在那里进行回收最为高效，同时偶尔也会在老年代进行空间回收。

一部分操作总是在 stop-the-world 阶段执行以提高吞吐量。其它会使应用程序停顿更长时间的操作(比如全局标记)是并行执行的, 并且会和应用程序并发执行。为了使回收空间的 stop-the-world 阶段更短, G1 以增量的方式分步进行空间回收，并且是并行执行的。G1 通过跟踪以前的应用行为和垃圾回收停顿的信息来构建一个预计成本(associated costs)的模型，从而实现可预测性。G1 使用这些信息来确定在停顿期间需要完成的工作量。例如，G1 会首先回收那些回收效率最高的区域（即那些几乎全是垃圾的区域）。

G1 主要通过疏散来回收空间: 在选定的内存区域中找到的存活对象会被复制到新的内存区域，并在此过程中进行压缩。疏散完成后，之前被存活对象占用的空间将被应用程序重新用于分配。

Garbage-First 回收器并不是一个实时回收器。它试图在较长的一段时间内以高概率满足设定的停顿时间目标，但并不能总是以绝对确定性保证每一次停顿都能达到这些目标。

## 堆结构

G1 将堆划分为一组大小相等的堆分区(heap regions)，每个分区是一个连续的虚拟内存范围，如图所示。分区是内存分配和内存回收的基本单位。在任何时候，这些分区可以是空的(图中的浅灰色部分)，或者被分配给某个特定的代(新生代或老年代)。随着内存请求的到来，内存管理器会分配空闲的分区。内存管理器将这些分区分配给某个代，然后将其作为空闲空间返回给应用程序，应用程序可以在这些空间中进行分配。

![](../../../img/jsgct_dt_004_grbg_frst_hp.png)
