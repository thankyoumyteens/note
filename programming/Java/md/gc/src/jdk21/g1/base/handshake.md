# 线程握手

在 JVM 中, 线程之间的"握手"通常是指在执行某些需要全局一致性或者线程间协调的操作时, JVM 与运行中的线程进行的一种同步机制。这种机制主要用于确保在执行关键操作(如垃圾回收、线程栈的快照、全局优化等)时, 不会破坏程序的一致性和完整性。以下是线程需要进行握手的几个原因:

1. **确保数据一致性**: 当 JVM 需要执行垃圾回收或其他全局操作时, 必须确保所有的线程都处于一个已知的、一致的状态。通过握手, JVM 可以安全地暂停线程(如果需要), 或者确保线程在安全点或握手安全状态下执行, 从而避免在一个线程修改数据的同时, 另一个线程也在访问或修改相同的数据
2. **减少停顿时间**: 在某些垃圾回收策略中, 如并发标记-复制算法, JVM 希望尽量减少因垃圾回收导致的应用程序线程暂停时间。通过握手, JVM 可以在线程执行到下一个安全点时自然地进行同步, 而不是强制立即暂停线程, 这样可以减少因同步操作导致的额外停顿
3. **提高资源利用率**: 握手机制允许 JVM 更高效地管理资源。例如, 在并发垃圾回收器中, 握手可以帮助 JVM 在线程不活跃时执行清理工作, 从而提高 CPU 和内存资源的利用率
4. **支持并发操作**: 在支持并发操作的垃圾回收器中, 如 ZGC 和 Shenandoah, 握手是实现并发标记和回收的关键。这些垃圾回收器通过握手机制与线程同步, 可以在应用程序线程继续执行的同时, 进行大部分垃圾回收工作
5. **优化性能**: 通过握手, JVM 可以更智能地安排垃圾回收和其他全局操作的时间, 以避免在应用程序的关键时期执行这些操作, 从而减少对应用程序性能的影响
6. **避免竞争条件**: 在多线程环境中, 为了避免竞争条件和数据不一致, JVM 需要在执行某些操作时确保所有线程都能够以一种协调的方式响应。握手提供了一种机制, 使得 JVM 可以在执行这些操作时与所有线程进行同步

## 握手安全状态

握手安全状态(Handshake Safe State)是指在 JVM 执行过程中, 线程可以安全地响应来自其他线程的操作请求(如暂停、中断等)的特定执行点。这个概念主要用于确保在执行某些全局操作(例如垃圾回收或者线程栈的快照)时, 所有的线程都能够以一种一致和安全的方式被处理。

在握手安全状态下, 线程会执行一个称为“握手”的过程, 这个过程涉及到与 JVM 的协调, 以确保线程在进入安全点之前不会执行可能导致不一致状态的操作。这个过程通常包括以下几个步骤:

1. **请求握手**: 当 JVM 需要执行全局操作时, 它会向所有运行中的线程发送一个握手请求
2. **响应握手**: 线程在接收到握手请求后, 会尝试执行到下一个安全点或者直接进入握手安全状态。在握手安全状态下, 线程会避免执行可能导致数据不一致的操作, 如内存写入、对象创建等
3. **同步**: 一旦线程进入握手安全状态, 它会与 JVM 进行同步, 确保在执行全局操作之前, 所有线程都处于一个一致的状态
4. **执行全局操作**: 在所有线程都响应握手并达到一致状态后, JVM 可以安全地执行全局操作, 如垃圾回收或者线程栈的快照

## 握手安全状态和安全点

握手安全状态(Handshake Safe State)和安全点(Safepoint)是 JVM 中用于确保垃圾回收和其他全局操作安全执行的两个相关概念:

1. **安全点(Safepoint)**:
   - 安全点是 JVM 在执行过程中预设的一些检查点。当 JVM 需要执行全局操作, 如 GC 或线程栈的快照时, 它会尝试将所有线程引导至最近的安全点。在安全点, JVM 可以确保所有线程的状态是一致的, 这样可以避免在一个线程正在修改数据时被暂停, 导致数据不一致的问题
   - 安全点通常是代码中的特定位置, 例如方法调用的返回点、循环的末尾、分支的汇合点等。当线程执行到这些点时, 它们会自愿暂停, 等待 JVM 的进一步指令
   - 安全点的实现可能会导致一定的性能开销, 因为线程需要在这些点上主动暂停, 等待 JVM 的同步信号
2. **握手安全状态(Handshake Safe State)**:
   - 握手安全状态是一种更为动态和灵活的机制, 它允许线程在响应 JVM 的握手请求时继续执行。这种状态下, 线程不会立即暂停, 而是在执行到下一个安全点或握手安全状态时自然地响应 JVM 的操作请求
   - 握手安全状态通常涉及到一种协调机制, 其中 JVM 会向所有运行中的线程发送握手请求, 线程在接收到请求后, 会尝试执行到下一个安全点或握手安全状态, 然后与 JVM 进行同步
   - 握手安全状态的设计旨在减少线程暂停的时间, 提高应用程序的响应性和吞吐量。它允许线程在等待与 JVM 同步的同时继续执行, 从而减少了因等待 GC 操作而造成的延迟

总结来说, 安全点是一种预设的检查点, 线程在这些点上会主动暂停等待 JVM 的指令；而握手安全状态则是一种动态的协调机制, 线程在响应 JVM 的握手请求时可以继续执行, 直到自然到达下一个安全点或握手安全状态。握手安全状态提供了一种更加灵活和高效的方式来处理全局操作, 特别是在需要最小化线程暂停时间的场景中。
