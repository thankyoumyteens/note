# 单线程模型

Redis 是一个单线程的工作模型，使用 I/O 多路复用来处理客户端的多个连接。

为什么 Redis 选择单线程也能效率这么高？

I/O 设备（如磁盘）的速度远远慢于 CPU，因此引入了多线程技术。当一个线程发起 I/O 请求时，先将它挂起，切换到别的线程。当 I/O 设备就绪时，再切换回该线程。多线程技术是为了充分利用 CPU 的计算资源，适用于下层存储慢速的场景。

而 Redis 是基于内存的操作，CPU 不是 Redis 的瓶颈，Redis 的瓶颈最有可能是机器内存的大小或者网络带宽。

既然 CPU 不会成为瓶颈, 也就不需要用到多个核心，而使用单线程模型又能带来更好的可维护性，方便开发和调试。如果使用多线程，那么将会使编程更加复杂，并且要考虑到加锁以及上下文切换等问题。

虽然 Redis 的处理客户端请求采用的是单线程 Reactor 工作模型，但实际上，Redis 在 4.0 之后的版本中就已经加入了对多线程的支持，在执行一些命令时就会使用主线程之外的其他后台线程协助处理，例如大键值对的删除操作。对于删除操作，如果键值对所占用的内存空间较小，单线程同步删除损耗也不会太大，如果键值对占用的内存空间较大，几十兆的文件，毫秒内是无法删除的，且释放内存也会有时间消耗，这些操作会阻塞其它操作，但是这些删除释放操作对其它操作并没有任何影响，所以可以异步执行，通过多线程非阻塞的释放内存空间，提高执行效率。

## Redis 6.0 的多线程

Redis6.0 引入多线程主要是为了提高网络 IO 读写性能，网络 I/O 的系统调用占用了 Redis 执行期间大部分 CPU 时间。

redis 支持多线程主要就是可以充分利用服务器多核 CPU 资源，多线程并行的进行网络 IO 操作，之前的线程模型只能利用一个核。

虽然 Redis6.0 引入了多线程，但是 Redis 的多线程只是在网络数据的读写这类耗时操作上使用，执行命令仍然是单线程顺序执行。因此不需要担心线程安全问题。

Redis6.0 的多线程默认是禁用的，只使用主线程，并且建议只在 4 核以及更多核心的机器上开启。如需开启需要修改 redis 配置文件 redis.conf 的 io-threads-do-reads 为 true。开启多线程后，还需要设置线程数，同样需要设置 redis 配置文件 redis.conf 的 io-threads 属性，4 核的机器建议设置为 2 或 3 个线程，8 核的建议设置为 6 个线程。
