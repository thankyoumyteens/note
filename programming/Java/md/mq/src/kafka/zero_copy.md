# 零拷贝

kafka 使用 sendfile 系统调用, 数据可以直接在内核空间内部进行 I/O 传输, 从而省去了数据在用户空间和内核空间之间的来回拷贝。 sendfile 调用中 I/O 数据对用户空间是完全不可见的。

基于 sendfile 系统调用的零拷贝方式, 整个拷贝过程会发生 2 次上下文切换, 3 次拷贝, 流程如下：

1. 用户进程通过 `sendfile()` 函数向内核发起系统调用, 上下文从用户态切换为内核态
2. CPU 将数据从主存或硬盘拷贝到内核的读缓冲区
3. CPU 将读缓冲区中的数据拷贝到 socket 缓冲区
4. CPU 将数据从 socket 缓冲区拷贝到网卡
5. 上下文从内核态切换回用户态, sendfile 系统调用返回

使用 sendfile, 用户程序不能对数据进行修改, 只适用于单纯的数据传输。
