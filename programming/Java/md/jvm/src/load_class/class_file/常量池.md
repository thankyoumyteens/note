# 常量池

紧接着主、次版本号之后的是常量池入口，由于常量池中常量的数量是不固定的，所以在常量池的入口需要放置一项u2类型的数据，代表常量池容量(constant_pool_count)。

这个容量计数是从1而不是0开始的，示例的常量池容量为0x0016，即十进制的22，这就
代表常量池中有21项常量，索引值范围为1～21。

如果后面某些指向常量池的索引值的数据在特定情况下需要表达不引用任何一个常量池项目，可以把索引值设置为0来表示。

常量池中主要存放两大类常量：字面量(Literal)和符号引用(Symbolic References)。

- 字面量比较接近于Java的常量概念，如文本字符串、被声明为final的常量值等
- 符号引用主要包括：被模块导出或者开放的包、类和接口的全限定名、字段的名称和描述符、方法的名称和描述符、方法句柄和方法类型、动态调用点和动态常量

Java代码在进行Javac编译的时候，并不像C和C++那样有连接这一步骤，而是在虚拟机加载Class文件的时候进行动态连接。在Class文件中不会保存各个方法、字段最终在内存中的信息，这些字段、方法的符号引用不经过虚拟机在运行期转换的话是无法得到真正的
内存入口地址，也就无法直接被虚拟机使用的。当虚拟机做类加载时，将会从常量池获得对应的符号引用，再在类创建时或运行时解析、翻译到具体的内存地址之中。

常量池中每一项常量都是一个表，常量表中分别有17种不同类型的常量。表结构起始的第一位是个u1类型的标志位，代表着当前常量属于哪种常量类型。这17种常量类型各自有着完全独立的数据结构。

---

常量池的项目类型：

| 类型                           | 标志(十进制) | 说明                     |
| -------------------------------- | ---- | -------------------------- |
| CONSTANT_Utf8_info               | 1    | UTF-8编码的字符串    |
| CONSTANT_Integer_info            | 3    | 整型字面量            |
| CONSTANT_Float_info              | 4    | 浮点型字面量         |
| CONSTANT_Long_info               | 5    | 长整型字面量         |
| CONSTANT_Double_info             | 6    | 双精度浮点型字面量 |
| CONSTANT_Class_info              | 7    | 类或接口的符号引用 |
| CONSTANT_String_info             | 8    | 字符串类型字面量   |
| CONSTANT_Fieldref_info           | 9    | 字段的符号引用      |
| CONSTANT_Methodref_info          | 10   | 类中方法的符号引用 |
| CONSTANT_InterfaceMethodref_info | 11   | 接口中方法的符号引用 |
| CONSTANT_NameAndType_info        | 12   | 字段或方法的部分符号引用 |
| CONSTANT_MethodHandle_info       | 15   | 方法句柄               |
| CONSTANT_MethodType_info         | 16   | 方法类型               |
| CONSTANT_Dynamic_info            | 17   | 动态计算常量         |
| CONSTANT_InvokeDynamic_info      | 18   | 动态方法调用点      |
| CONSTANT_Module_info             | 19   | 模块                     |
| CONSTANT_Package_info            | 20   | 一个模块中开放或者导出的包 |

常量池中的17种数据类型的结构：



---

```java
public class ClassFileDemo {
    int num;

    public int getNum() {
        return this.num;
    }
}
```

字节码文件内容:

![](./img/class_file.png)

常量池容量为`0x0016`，即十进制的22，代表常量池中有21项常量，索引值范围为1～21。

常量池的第一项常量，它的标志位是`0x0A`，即十进制的10，对应的常量是CONSTANT_Methodref_info类型，此类型的常量代表一个类中方法的符号引用。

tag是标志位，它用于区分常量类型；name_index是常量池的索引值，它指向常量池中一个
CONSTANT_Utf8_info类型常量，此常量代表了这个类（或者接口）的全限定名，本例中的
name_index值（偏移地址：0x0000000B）为0x0002，也就是指向了常量池中的第二项常量。继续从图6-
3中查找第二项常量，它的标志位（地址：0x0000000D）是0x01，查表6-3可知确实是一个
CONSTANT_Utf8_info类型的常量。CONSTANT_Utf8_info类型的结构如表6-5所示。

