# 验证

验证(Verification)是连接阶段(Linking)的第一步，它的目的是保证加载的字节码是安全且合规的。

验证阶段会消耗大量的时间，如果程序运行的全部代码都已经被反复使用和验证过，在生产环境就可以考虑使用 -Xverify:none 参数来关闭大部分的类验证措施，以缩短虚拟机类加载的时间。

## 文件格式验证

验证字节流是否符合 Class 文件格式的规范，并且能被当前版本的虚拟机处理。比如验证是否以魔数`0xCAFEBABE`开头。主、次版本号是否在当前 Java 虚拟机接受范围之内。常量池的常量中是否有不被支持的常量类型等。

## 元数据验证

对字节码描述的信息进行语义分析，以保证其描述的信息符合要求，比如验证这个类是否有父类、是否继承了被 final 修饰的类、类中的字段和方法是否与父类产生矛盾等。

## 字节码验证

主要目的是通过数据流分析和控制流分析，确定程序是合法的、符合逻辑的。这阶段要 Class 文件中的 Code 属性进行校验分析，保证类的方法在运行时不会做出危害虚拟机安全的行为。

为了避免过多的执行时间消耗在字节码验证阶段中，在 JDK 6 之后的 Javac 编译器和 Java 虚拟机里进行了一项联合优化，把尽可能多的校验辅助措施挪到 Javac 编译器里进行。具体做法是给方法体 Code 属性的属性表中新增加了一项名为 StackMapTable 的新属性，在字节码验证期间，Java 虚拟机只需要检查 StackMapTable 属性中的记录是否合法即可，从而节省了大量校验时间。但 StackMapTable 属性也存在错误或被篡改的可能。

## 符号引用验证

符号引用验证发生在虚拟机将符号引用转化为直接引用的时候，这个转化动作将在连接的解析阶段中发生。

符号引用验证可以看作是对类自身以外(常量池中的各种符号引用)的各类信息进行校验，即该类是否缺少或者被禁止访问它依赖的某些外部类、方法、字段等资源。
