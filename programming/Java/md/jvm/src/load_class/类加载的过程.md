# 类加载的过程

类的加载过程包括，加载、验证、准备、解析和初始化这五个阶段。

### Resolution (解析)

解析阶段将常量池中的符号引用转为直接引用。

符号引用以一组符号来描述所引用的目标。在编译时，Java 类并不知道所引用的类的实际内存地址，因此只能使用符号引用来代替。

如下字节码文件中的常量池：
```
Constant pool:
   #1 = Methodref          #4.#16         // java/lang/Object."<init>":()V
   #2 = Methodref          #3.#17         // com/jvm/classloading/B.b2:(II)I
   #3 = Class              #18            // com/jvm/classloading/B
   #4 = Class              #19            // java/lang/Object
   #5 = Utf8               <init>
   #6 = Utf8               ()V
   #7 = Utf8               Code
   #8 = Utf8               LineNumberTable
   #9 = Utf8               main
  #10 = Utf8               ([Ljava/lang/String;)V
  #11 = Utf8               b1
  #12 = Utf8               (II)I
  #13 = Utf8               b2
  #14 = Utf8               SourceFile
  #15 = Utf8               B.java
  #16 = NameAndType        #5:#6          // "<init>":()V
  #17 = NameAndType        #13:#12        // b2:(II)I
  #18 = Utf8               com/jvm/classloading/B
  #19 = Utf8               java/lang/Object
```

## Initialization (初始化)

初始化阶段执行类的初始化方法：`<clinit>()` 方法，为类的静态变量赋予正确的初始值。

`<clinit>()` 方法仅能由 Java 编译器生成并由 JVM 调用，程序开发者无法自定义和调用该方法。它是编译器自动收集类变量的赋值语句以及 static 代码块合并而来。

例：

```java
public class InitializationTest2 {
    // 在初始化阶段<clinit>()中赋值
    public static int a = 1;
    // 在链接阶段的准备环节赋值
    public static final int INT_CONSTANT = 10;
    // 在初始化阶段<clinit>()中赋值
    public static final Integer CONSTANT1 = Integer.valueOf(100);
    // 在初始化阶段<clinit>()中赋值
    public static Integer CONSTANT2 = Integer.valueOf(1000);
    // 在链接阶段的准备环节赋值
    public static final String s0 = "helloworld0";
    // 在初始化阶段<clinit>()中赋值
    public static final String s1 = new String("helloworld1");
}
```

虚拟机会保证一个类的 `<clinit>()` 方法在多线程环境中被正确地加锁、同步，如果多个线程同时去初始化一个类，那么只会有一个线程去执行这个类的 `<clinit>()` 方法，其他线程都需要阻塞等待，直到活动线程执行 `<clinit>()` 方法完毕。如果之前的线程成功加载了类，则等在队列中的线程就没有机会再执行 `<clinit>()` 方法了，当需要使用这个类时，虚拟机会直接返回给它已经准备好的信息。

当初始化子类时，如果发现其父类还没有进行过初始化，则需要先触发其父类的初始化。
