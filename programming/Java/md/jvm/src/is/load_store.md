# 加载和存储指令

加载和存储指令用于将数据在栈帧中的局部变量表和操作数栈之间来回传输。

## 将一个局部变量加载到操作栈

从局部变量表加载一个 {x} 类型的值加载到操作数栈的栈顶:

```
操作码:
        {x}load
操作数:
        index
操作数栈-执行前:
        -
操作数栈-执行后:
        value
```

{x} 需要替换成下面的值的其中之一:

- i: int
- l: long
- f: float
- d: double
- a: 引用类型

比如: iload 表示从局部变量表加载一个 int 类型值到操作数栈的栈顶。

index 是一个 byte 类型的整数, 它代表当前栈帧中局部变量表的索引。index 作为索引定位的局部变量必须是 {x} 类型, 记为 value。指令执行后, value 将会压入到操作数栈的栈顶。

### {x}load 的简写指令

由于局部变量表的大小一般不会太大, jvm 为局部变量表索引为 3 以内的操作提供了对应的简写指令。

把局部变量表索引为 {i} 的 {x} 类型的值加载到操作数栈的栈顶:

```
操作码:
        {x}load_{i}
操作数:
        -
操作数栈-执行前:
        -
操作数栈-执行后:
        value
```

{i} 需要替换成 0 到 3 的其中之一。比如: iload_0 表示加载局部变量表索引为 0 的 int 值到操作数栈的栈顶。

## 将一个值从操作数栈存储到局部变量表

把操作数栈顶的一个 {x} 类型的值存储到局部变量表中:

```
操作码:
        {x}store
操作数:
        index
操作数栈-执行前:
        value
操作数栈-执行后:
        -
```

{x} 需要替换成下面的值的其中之一:

- i: int
- l: long
- f: float
- d: double
- a: 引用类型

比如: istore 表示将栈顶 int 类型的数值存入局部变量表中的指定位置。

index 是一个无符号 byte 型整数, 它是当前栈帧局部变量表的索引值, 而在操作数栈栈顶的 value 必须是 {x} 类型的数据, 这个数据将从操作数栈出栈, 然后保存到 index 所指向的局部变量表位置中。

### {x}store 的简写指令

由于局部变量表的大小一般不会太大, jvm 为局部变量表索引为 3 以内的操作提供了对应的简写指令。

把操作数栈顶 {x} 类型的值存入局部变量表中索引为 {i} 的位置:

```
操作码:
        {x}store_{i}
操作数:
        -
操作数栈-执行前:
        value
操作数栈-执行后:
        -
```

{i} 需要替换成 0 到 3 的其中之一。比如: istore_0 表示把操作数栈顶 int 类型的值存入局部变量表中索引为 0 的位置。

## 将一个常量加载到操作数栈

### bipush

把一个 byte 类型数据(-128~127)存入操作数栈顶:

```
操作码:
        bipush
操作数:
        byte
操作数栈-执行前:
        -
操作数栈-执行后:
        value
```

将 byte 带符号扩展为一个 int 类型的值 value, 然后将 value 压入到操作数栈中。

### sipush

把一个 short 类型数据(-32768~32767)存入操作数栈顶:

```
操作码:
        sipush
操作数:
        byte1,byte2
操作数栈-执行前:
        -
操作数栈-执行后:
        value
```

无符号数 byte1 和 byte2 通过`(byte1 << 8) | byte2` 的方式构造成一个 short 类型的数, 然后此数值带符号扩展为一个 int 类型的值 value, 最后将 value 压入到操作数栈中。

### ldc

把运行时常量池中的 int/float/String 类型的数据存入操作数栈顶:

```
操作码:
        ldc
操作数:
        index
操作数栈-执行前:
        -
操作数栈-执行后:
        value
```

index 是一个无符号 byte 型数据, 它是当前类的运行时常量池的索引。index 指向的必须是 int/float/String 类型的值。如果指向一个 int/float 类型的运行时常量, 那这个常量所对应的数值 value 将被压入到操作数栈之中。如果指向一个代表字符串字面量的 String 类的引用, 那这个引用所对应的引用类型数据 value 将被压入到操作数栈之中。如果指向一个类的符号引用, 且这个符号引用是已被解析过的, 那这个类的 Class 对象所对应的引用类型数据 value 将被压入到操作数栈之中。

### ldc_w

把运行时常量池中的 int/float/String 类型的数据存入操作数栈顶。

它和 ldc 的区别: ldc 操作的常量池索引只有一个字节, 按无符号整数计算最大也就是 255, 所以 ldc 可操作常量池索引的范围是 0 到 255。而 ldc_w 有两个字节, 它可以操作的常量池索引范围是 256 到 65535。

```
操作码:
        ldc_w
操作数:
        indexbyte1,indexbyte2
操作数栈-执行前:
        -
操作数栈-执行后:
        value
```

无符号数 indexbyte1 和 indexbyte2 用于构建一个当前类的运行时常量池的索引值, 构建方式为`(indexbyte1 << 8) | indexbyte2`。

### ldc2_w

把运行时常量池中的 long/double 类型的数据存入操作数栈顶:

```
操作码:
        ldc2_w
操作数:
        indexbyte1,indexbyte2
操作数栈-执行前:
        -
操作数栈-执行后:
        value
```

无符号数 indexbyte1 和 indexbyte2 用于构建一个当前类的运行时常量池的索引值, 构建方式为`(indexbyte1 << 8) | indexbyte2`, 该索引所指向的运行时常量池项应当是一个 long/double 类型的运行时常量。

### 加载常量的简写指令

jvm 提供了加载常用的常量的简写指令:

| 操作码      | 操作数 | 操作数栈-执行前 | 操作数栈-执行后 | 操作                            |
| ----------- | ------ | --------------- | --------------- | ------------------------------- |
| aconst_null | -      | -               | null            | 将 null 推送至栈顶              |
| iconst_m1   | -      | -               | -1              | 将 int 类型数据 -1 推送至栈顶   |
| iconst_0    | -      | -               | 0               | 将 int 类型数据 0 推送至栈顶    |
| iconst_1    | -      | -               | 1               | 将 int 类型数据 1 推送至栈顶    |
| iconst_2    | -      | -               | 2               | 将 int 类型数据 2 推送至栈顶    |
| iconst_3    | -      | -               | 3               | 将 int 类型数据 3 推送至栈顶    |
| iconst_4    | -      | -               | 4               | 将 int 类型数据 4 推送至栈顶    |
| iconst_5    | -      | -               | 5               | 将 int 类型数据 5 推送至栈顶    |
| lconst_0    | -      | -               | 0               | 将 long 类型数据 0 推送至栈顶   |
| lconst_1    | -      | -               | 1               | 将 long 类型数据 1 推送至栈顶   |
| fconst_0    | -      | -               | 0               | 将 float 类型数据 0 推送至栈顶  |
| fconst_1    | -      | -               | 1               | 将 float 类型数据 1 推送至栈顶  |
| fconst_2    | -      | -               | 2               | 将 float 类型数据 2 推送至栈顶  |
| dconst_0    | -      | -               | 0               | 将 double 类型数据 0 推送至栈顶 |
| dconst_1    | -      | -               | 1               | 将 double 类型数据 1 推送至栈顶 |
