# 插件

在 `jlink` 工具中，插件是扩展其功能的核心机制，用于在生成自定义运行时镜像的过程中执行额外操作（如优化、定制、验证等）。`jlink` 本身内置了多个官方插件，同时也支持通过自定义插件扩展功能。

## 官方内置插件

`jlink` 的官方插件通过 `--plugin <插件名[:参数]>` 选项启用，核心插件如下：

#### 1. `compress`

- **作用**：压缩模块中的资源文件（如类文件、配置文件等），减小镜像体积
- **参数**：指定压缩级别（与命令行 `--compress` 选项功能一致，插件形式更灵活）
  - `0`：不压缩（默认）
  - `1`：仅压缩字符串常量
  - `2`：压缩所有资源（使用 ZIP 压缩）
- **示例**：
  `jlink --plugin compress=2 ...`（等效于 `--compress 2`）

#### 2. `strip-debug`

- **作用**：移除镜像中的调试信息（如 `.class` 文件中的行号、局部变量表等），进一步减小体积
- **特点**：与命令行 `--strip-debug` 选项功能一致，插件形式可与其他插件组合使用
- **示例**：  
  `jlink --plugin strip-debug ...`

#### 3. `include-locales`

- **作用**：仅包含指定的本地化资源（如语言、地区相关的 `ResourceBundle` 数据），剔除无关本地化文件（如只保留 `zh_CN`、`en_US`）
- **参数**：以逗号分隔的语言/地区代码（如 `zh_CN,en_US`）
- **场景**：国际化应用按需保留本地化资源，减少镜像体积（默认包含所有本地化数据，体积较大）
- **示例**：  
  `jlink --plugin include-locales=zh_CN,en_US ...`

#### 4. `exclude-files`

- **作用**：从生成的镜像中排除指定模式的文件（支持通配符）
- **参数**：文件路径模式（如 `**/*.txt` 排除所有 `.txt` 文件）
- **示例**：  
  `jlink --plugin exclude-files=**/*.log ...`（排除所有 `.log` 文件）

#### 5. `include-files`

- **作用**：向镜像中添加额外的自定义文件（如配置文件、脚本等），并指定目标路径
- **参数**：`源文件路径:镜像中目标路径`（支持通配符）
- **场景**：在运行时镜像中嵌入应用所需的配置文件（如 `config.properties`）
- **示例**：  
  `jlink --plugin include-files=./config/*:/app/config/ ...`（将 `./config` 下的文件添加到镜像的 `/app/config` 目录）

#### 6. `jmods`

- **作用**：指定额外的 `jmod` 文件路径（`jmod` 是 Java 模块的打包格式，包含模块代码和元数据）
- **参数**：`jmod` 文件所在目录路径
- **场景**：当模块路径中需要包含自定义或第三方 `jmod` 文件时使用
- **示例**：  
  `jlink --plugin jmods=./my-jmods ...`。

#### 7. `system-module-path`

- **作用**：覆盖默认的系统模块路径（默认是 `$JAVA_HOME/jmods`），指定自定义的系统模块位置
- **参数**：自定义系统模块目录路径
- **场景**：使用定制化 JDK 模块（如裁剪过的 `java.base`）时
- **示例**：  
  `jlink --plugin system-module-path=./custom-jmods ...`

#### 8. `verify`

- **作用**：验证生成的镜像是否符合模块规范（如依赖完整性、模块描述符正确性等），确保镜像可正常运行
- **特点**：增加构建时间，但能提前发现模块配置错误
- **示例**：
  `jlink --plugin verify ...`

## 自定义插件

`jlink` 支持通过 Java 服务加载机制扩展自定义插件，需实现 `java.tools.jlink.Plugin` 接口，并打包为模块供 `jlink` 加载。常见的第三方插件场景包括：

- **自定义压缩算法**：针对特定文件类型优化压缩（如二进制资源）。
- **签名与加密**：对镜像中的模块文件进行签名或加密，增强安全性。
- **静态分析**：在生成镜像时对模块依赖进行深度分析，生成报告。

实现自定义插件的步骤：

1. 创建模块化项目，定义模块并声明对 `jdk.jlink` 模块的依赖（`requires jdk.jlink;`）
2. 实现 `Plugin` 接口，重写 `name()`（插件名）、`process()`（处理逻辑）等方法
3. 将插件打包为 `jmod` 或模块化 JAR，通过 `--module-path` 引入 `jlink`
4. 使用 `--plugin <自定义插件名[:参数]>` 启用

## 组合使用插件

多个插件可同时生效，例如 `--plugin compress=2 --plugin strip-debug`。
