# String 存储结构优化

Java 9 对 String 类的存储结构进行了重大优化，将原本基于 `char[]` 的内部存储改为 `byte[]` + 编码标记（coder），旨在减少字符串占用的内存空间，尤其对 Latin-1 字符（单字节字符，如英文字母、数字、常见符号）为主的场景优化显著。

在 Java 9 之前，String 内部通过 `char[]` 数组存储字符，每个 char 占用 2 个字节（采用 UTF-16 编码）。这一设计存在明显弊端：

- 对于仅包含 Latin-1 字符（如英文、数字、标点符号）的字符串，每个字符仅需 1 个字节即可表示，但 `char[]` 仍会占用 2 个字节，导致 50% 的内存浪费
- 随着应用中字符串数量增多（如日志、网络数据、配置信息），这种浪费会显著增加内存占用，影响系统性能（如 GC 压力增大）

Java 9 重构了 String 的内部结构，核心变化如下：

1. 存储载体从 `char[]` 改为 `byte[]`：用字节数组存储字符，每个字符根据编码方式占用 1 或 2 个字节。
2. 新增 coder 字段标记编码：一个 byte 类型的字段（占 1 字节），用于标记字符串使用的编码：
   - 0：表示 Latin-1 编码（单字节字符，范围 \u0000 - \u00FF）
   - 1：表示 UTF-16 编码（双字节字符，用于存储非 Latin-1 字符，如中文、日文、emoji 等）
3. 示例
   - 对于纯 Latin-1 字符串（如 "hello"、"user123"），存储体积减少 50%（每个字符从 2 字节变为 1 字节）
   - 对于包含非 Latin-1 字符的字符串（如 "你好，world"），仍使用 UTF-16 编码，内存占用与优化前一致
4. 外部接口（如 charAt()、length()、getBytes() 等）保持不变，开发者无需修改代码即可享受优化收益。例如：
   - `charAt(int index)` 会根据 coder 字段判断：若为 Latin-1 编码，直接通过 `byte[index]` 转换为 char；若为 UTF-16 编码，则按 2 字节解析
   - `length()` 方法通过 coder 计算字符数（Latin-1 编码时 `byte.length` 即字符数；UTF-16 编码时长度为 `byte.length / 2`）
