# Redis 怎么实现分布式锁

使用setnx（set if not exists）
```
setnx lock true
# 逻辑处理
del lock
```
当执行 setnx 命令之后返回值为 1 的话，则表示创建锁成功，否则就是失败

但是以上代码有一个问题，就是没有设置锁的超时时间，因此如果出现异常情况，会导致锁未被释放，而其他线程又在排队等待此锁就会导致程序不可用。

而`setnx lock true` 和 `expire lock 30` 命令是两条命令，也就是一个执行完另一个才能执行。但如果在 setnx 命令执行完之后，发生了异常情况，那么就会导致 expire 命令不会执行，因此依然没有解决死锁的问题。

这个问题在 Redis 2.6.12 版本中得到了有效的处理。

在 Redis 2.6.12 中我们可以使用一条 set 命令来执行键值存储，并且可以判断键是否存在以及设置超时时间
```
set lock true ex 30 nx
```
ex 是用来设置超时时间的，而 nx 是 not exists 的意思，用来判断键是否存在。如果返回的结果为“OK”则表示创建锁成功，否则表示此锁有人在使用。

# Redis 分布式锁有什么缺陷

Redis 分布式锁不能解决超时的问题，分布式锁有一个超时时间，程序的执行时间如果超出了锁的超时时间就会出现问题。
