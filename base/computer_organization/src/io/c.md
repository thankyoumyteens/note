# 主机与 I/O 设备通讯的方式

## 程序查询方式

大体流程:

![](../img/cxcxfs.jpg)

程序查询方式的特点是每时每刻不断查询 I/O 设备是否准备就绪。

详细流程:

![](../img/cxcxfs2.jpg)

## 程序中断方式

中断: 计算机在程序执行过程中，当出现异常或者特殊情况时，计算机停止现行程序的执行转向对这些异常情况或特殊情况的处理，处理结束后再返回现行程序的间断处，继续执行原程序。

### 中断请求

中断请求是指中断源向 CPU 发送中断请求信号, 分类:

- 内中断和外中断:
  - 内中断: 来自 CPU 和内存的中断，如除数为 0 等程序运算产生的错误或者内存不足、空间分配失败产生的中断
  - 外中断: 来自 CPU 和内存以外的部件产生的中断，如 I/O 设备的中断
- 硬中断和软中断:
  - 硬中断: 通过外部硬件产生的中断。硬中断属于外中断
  - 软中断: 通过指令产生的中断，可编程实现。软中断属于内中断
- 非屏蔽中断和可屏蔽中断
  - 都属于外中断

### 中断判优

中断系统在某一时刻只能响应一个中断源的请求，但不同中断源发出请求是随机的，因此可能某一时刻会同时产生多个中断请求，这时候要按照某种规则来选择一个中断请求进行响应。

一般硬件故障属于最高级中断，其次是软件中断，非屏蔽中断高于可屏蔽中断，DMA 请求高于 I/O 设备，高速设备高于低速设备，输入设备高于输出设备，实时设备高于普通设备。

### 中断响应和处理

响应条件: 必须满足 CPU 中的允许中断触发器 EINT 为“1”。该触发器可以用开中断指令打开，可以用关中断指令或者由硬件自动关闭。

响应时间: CPU 响应中断的时间是在每条指令执行阶段的结束时刻。

中断处理:

1. 保护现场
2. 中断服务
3. 恢复现场
4. 中断返回

## 多重中断

CPU 具备多重中断功能的条件:

1. 在中断服务程序中提前设置开中断指令
2. 优先级别高的中断有权中断优先级别低的中断

屏蔽字: 每个中断源都有一个屏蔽触发器，1 表示屏蔽该中断源的中断请求，0 表示接受该中断源的中断请求；所有屏蔽触发器组合在一起构成一个屏蔽字寄存器，屏蔽字寄存器的内容称之为屏蔽字。

## DMA 方式

主存和 DMA 接口之间有一条专用的数据通路，因此主存和设备交换信息时，不需要通过 CPU，也不需要暂停 CPU 现行程序去为设备服务，使得 I/O 与主机并行工作，程序和数据传输并行工作，省去了保护现场和恢复现场的步骤，因此速度较快。

### DMA 数据传输过程

预处理

- 给 DMA 控制逻辑指明数据传输方向是输入还是输出
- 向 DMA 设备地址寄存器送入设备号，并启动设备
- 向 DMA 主存地址寄存器送入交换数据的主存起始地址
- 对字计数器赋予交换数据的个数

上述操作由 CPU 执行几条输入输出指令来完成，这些工作完成后 CPU 继续执行原来的程序。

DMA 输入过程:

1. 当设备准备好一个字时, 先发出选通信号, 将该字读到 DMA 的数据缓冲寄存器(BR)中, 表示数据缓冲寄存器"满"
2. 与此同时, 设备向 DMA 接口发请求(DREQ)
3. DMA 接口向 CPU 申请总线控制权(HRQ)
4. 如果 CPU 同意, 会发回 HLDA 信号, 表示允许将总线控制权交给 DMA 接口
5. 将 DMA 主存地址寄存器中的主存地址送到地址总线, 并命令主存写
6. 通知设备已被授予一个 DMA 周期(DACK), 并为交换下一个字做准备
7. 将 DMA 数据寄存器中的内容送到数据总线
8. 主存将数据总线上的数据写到地址总线指定的存储单元中
9. 修改主存地址和字计数器值
10. 断数据块是否传送结束，若未结束，则继续传送；若已结束，则向 CPU 申请程序中断，标志数据块传输结束

DMA 输出过程:

1. 当 DMA 数据缓冲寄存器已将输出数据送至 I/O 设备后，表示数据缓冲寄存器已“空”
2. 设备向 DMA 接口发请求(DREQ)
3. DMA 接口向 CPU 申请总线控制权(HRQ)
4. CPU 发回 HLDA 信号，表示允许将总线控制权交给 DMA 接口使用
5. 将 DMA 主存地址寄存器中的主存地址送地址总线，并命令存储器读
6. 通知设备已被授予一个 DMA 周期(DACK), 并为交换下一个字做准备
7. 主存将相应地址单元的内容通过数据总线读入到 DMA 的数据缓冲寄存器
8. 将 DMA 的数据缓冲寄存器的内容送到输出设备，若为字设备，则将其拆成字符输出
9. 修改主存地址和字计数值
10. 判断数据块是否传送结束，若未结束，则继续传送；若已结束，则向 CPU 申请程序中断，标志数据块传输结束

后处理

当 DMA 的中断请求得到响应之后，CPU 停止原程序的执行，转去执行中断服务程序，做一些 DMA 的结束工作，包括校验送入主存的数据是否正确、测试传输过程中是否出错和决定是否继续用 DMA 传输其他数据块。

DMA 方式特点

- DMA 使 CPU 与主存之间不存在固定联系，主存即可以被 CPU 访问，又可以被外设访问
- 在数据传输的时候，主存地址确定、传输数据的计数都由硬件电路直接实现
- 主存中要开辟专用缓冲区，以便随时供给和接收外设的数据
- DMA 使得 CPU 和外设并行，提高系统效率
- DMA 在开始前要通过程序进行预处理，结束后要通过中断方式进行后处理

DMA 和中断的区别

- 中断方式是程序的切换，需要保护和恢复现场；而 DMA 方式除了预处理和后处理，其他时候不占用 CPU 资源
- 中断请求的响应只能发生在每条指令的执行周期之后；而对 DMA 的响应可以在取指周期、间址周期、执行周期之后均可以，只要 CPU 不占用总线就可以被响应
- 中断传输过程需要 CPU 的干预，而 DMA 的传输过程不需要； (4)DMA 请求的优先级高于中断请求优先级
- 中断功能多，比如可以处理异常，而 DMA 仅仅是为了 I/O 数据传输设计的
- 从数据传输来看，中断靠程序传输，DMA 靠硬件传输
