# Cache

Cache（缓存）是一种用于提高数据访问速度的技术。它通常存储的是最近或最频繁使用的数据副本，以便于快速访问这些数据。当系统再次请求相同的数据时，它可以先检查缓存中是否存在该数据的副本，如果存在（这称为命中），则可以直接从缓存中读取数据，而不是重新计算或从原始位置加载，这样可以大大减少延迟并提高性能。

## 程序的局部性访问原理

- 时间局部性: 现在正在用的数据, 很可能在不久的将来还会用到
- 空间局部性: 现在正在用的数据, 很可能和在不久的将来要用到的数据在空间上相邻

## 主存到 cache 的地址映射

cache 和主存之间的数据交换是以 字块 为单位的(一个块由多个字组成)。cache 和 CPU 之间的数据交换是以字为单位的(因为寄存器每次只能读写一个字)。

从地址的角度理解分块:

1. n 位地址分成两块: 块地址是 1 位, 块内地址是 n - 1 位 0XXXXX... 和 1XXXXX...
2. n 位地址分成四块: 块地址是 2 位, 块内地址是 n - 2 位 00XXXX..., 01XXXX..., 10XXXX... 和 11XXXX...
3. n 位地址分成 2<sup>m</sup> 块: 块地址是 m 位, 块内地址是 n - m 位, 每个块的大小是 2<sup>n - m</sup> 个字

### 直接映射

在这种映射方式中，每个主存块只能映射到缓存中的一个特定位置。这种方式相对简单，但可能会导致冲突，即多个主存块映射到同一个缓存位置，从而降低缓存的命中率。主存的 1 号块对应 cache 的 1 号块, 主存的 2 号块对应 cache 的 2 号块, ...

假设主存的容量是 8 个块, cache 的容量是 4 个块。则主存的块地址是 3 位, cache 的块地址是 2 位。主存的块数是 cache 的两倍, 所以 cache 的每个地址可以映射到主存的两个块。cache 需要设置 1 位标记来区分对应主存的哪个块。

CPU 给出的主存地址由三部分组成：主存字块标记，Cache 字块地址，字块内地址。块内地址在 Cache 和主存中相同。由于主存的块数是 cache 的好几倍, 所以 cache 的每个块可以映射到主存的多个块。比如主存的容量是 8 个块, cache 的容量是 4 个块。则主存的第 1 块和第 5 块都会映射到 cache 的第 1 块。这就需要用额外的标记来区分映射过来的是第 1 块还是第 5 块。主存和 cache 中都会加上这个标记, 根据主存字块标记和 cache 上的标记是否相同来判断。

主存块对应的 cache 块号: `主存的块号 % cache的块数` 假设 cache 的容量是 4 个块, 那么主存中块号 6 映射到 cache 中就是 `6 % 4` = 2 号块。

cache 的标记位长度: `主存地址位数 - cache地址位数`。

#### 例题

主存容量为 512KB, cache 的容量是 4KB, 每个块 16 个字, 每个字 32 位(按字节寻址)。

(1) cache 的地址有多少位, 有多少块

cache 容量为 4KB = 2<sup>12</sup>B, 所以地址是 12 位。

每个块 16 个字, 每个字 32 位(4 个字节), 所以每个块 64 个字节, cache 有 2<sup>12</sup>B ÷ 64B = 2<sup>6</sup> 个块。

(2) 主存的地址有多少位, 有多少块

主存容量为 512KB = 2<sup>19</sup>B, 所以地址是 19 位。

每个块 64 个字节, 主存有 2<sup>19</sup>B ÷ 64B = 2<sup>13</sup> 个块。

(3) 采用直接映射方式, 则主存的第几块会映射到 cache 的第 7 块(起始块设为第 1 块)

主存的第 7 块会映射到 cache 的第 7 块。

主存的第 7 块会映射到 cache 的第 7 块。

主存的第 7 + 2<sup>6</sup> 块也会映射到 cache 的第 7 块。

主存的第 7 + 2<sup>6</sup> + 2<sup>6</sup> = 7 + 2 × 2<sup>6</sup> 块也会映射到 cache 的第 7 块。

主存的第 7 + 3 × 2<sup>6</sup> 块也会映射到 cache 的第 7 块。

...

以 2<sup>6</sup> 为步长在主存上寻找, 最大会移动 2<sup>13</sup> ÷ 2<sup>6</sup> = 2<sup>7</sup> 次。所以主存的第 7 + 2<sup>7</sup> × 2<sup>6</sup> 块也会映射到 cache 的第 7 块, 但是 7 + 2<sup>7</sup> × 2<sup>6</sup> 已经超出了主存的地址范围, 所以退回一步, 第 7 + (2<sup>7</sup> - 1) × 2<sup>6</sup> 块是最后一个映射到 cache 的第 7 块上的主存块。

(4) 画出当前主存地址的各段位数

- cache 有 2<sup>12</sup>B ÷ 64B = 2<sup>6</sup> 个块, 所以 cache 块地址: 6 位
- cache 地址是 12 位, 所以块内地址: 12 - 6 = 6 位
- 主存字块标记: 19 - 12 = 7 位

```
[主存字块标记: 7位][cache块地址: 6位][块内地址: 6位]
```

### 全相联映射

cache 中的每一个块都可能被主存的任意一个块映射。cache 中需要更长的标记位来指出对应主存中的哪个块。

假设主存的容量是 8 个块, 则主存的块地址是 3 位, 那么 cache 的标记位就是 3 位。

全相联映射没有块地址。

### 组相联映射

把 cache 中的块分组, 以组为单位和内存之间采用直接映射, 但是内存块具体映射到 cache 组内的哪个块, 则采用全相联映射。

假设 cache 的容量是 8 个块, 把它们两个块为一组, 一共有四组。则内存中第 1 块映射到 cache 第 1 组中的任意一个块, 内存中第 2 块映射到 cache 第 2 组中的任意一个块, ... , 内存中第 5 块映射到 cache 第 1 组中的任意一个块, ...

cache 的标记位长度: cache 每一组内有 2<sup>r</sup> 块, cache 和主存地址相差 t 位, 则标记位的长度是 t+r 位。
