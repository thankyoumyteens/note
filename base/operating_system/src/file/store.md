# 文件的物理结构

类似于内存分页, 磁盘中的存储单元也会被分为一个个的块(磁盘块/物理块)。很多操作系统中, 磁盘块的大小与内存块、页面的大小相同。内存与磁盘之间的数据交换都是以磁盘块为单位进行的。即每次读入一块, 或每次写出一块。

用户通过逻辑地址来操作自己的文件, 操作系统要负责实现从逻辑地址到物理地址的映射。文件的逻辑地址也可以表示为 `(逻辑块号, 块内地址)` 的形式。

## 连续分配

连续分配方式要求每个文件在磁盘上占有一组连续的块。文件目录中记录存放的起始块号和长度(总共占用几个块)。

用户给出要访问的逻辑块号, 操作系统找到该文件对应的目录项(FCB), `物理块号 = 起始块号 + 逻辑块号`。

可以直接算出逻辑块号对应的物理块号, 因此连续分配支持顺序访问和直接访问(即随机访问)。

读取某个磁盘块时, 需要移动磁头。访问的两个磁盘块相隔越远, 移动磁头所需时间就越长。所以连续分配的文件在顺序读/写时速度最快。

若物理上连续分配的文件 A 占用了连续的三个块, 文件 A 的后面已经没有相邻的空闲块, 若此时文件 A 要拓展, 需要再增加一个磁盘块(总共需要连续的 4 个磁盘块)。由于采用连续结构, 因此文件 A 占用的磁盘块必须是连续的。因此只能将文件 A 全部迁移到空闲区域。所以物理上采用连续分配的文件不方便拓展, 存储空间利用率低, 会产生难以利用的磁盘碎片。

- 优点：支持顺序访问和直接访问(即随机访问)；连续分配的文件在顺序访问时速度最快
- 缺点：不方便文件拓展；存储空间利用率低, 会产生磁盘碎片

## 链接分配

链接分配采取离散分配的方式, 可以为文件分配离散的磁盘块。分为隐式链接和显式链接两种。

### 隐式链接

文件目录中记录了文件存放的起始块号和结束块号。也可以增加一个字段来表示文件的长度。除了文件的最后一个磁盘块之外, 每个磁盘块中都会保存指向下一个盘块的指针, 这些指针对用户是透明的。

| 文件名   | ... | 起始块号 | 结束块号 |
| -------- | --- | -------- | -------- |
| demo_dir | ... | 0        | 100      |
| 1.jpg    | ... | 101      | 210      |

实现文件的逻辑块号到物理块号的转变: 用户给出要访问的逻辑块号 i, 操作系统找到该文件对应的目录项(FCB), 从目录项中找到起始块号(即 0 号块), 将 0 号逻辑块读入内存, 由此知道 1 号逻辑块存放的物理块号, 于是读入 1 号逻辑块, 再找到 2 号逻辑块的存放位置, 以此类推。因此, 读入 i 号逻辑块, 总共需要 i+1 次磁盘 I/O。

采用隐式链接方式的文件, 只支持顺序访问, 不支持随机访问, 查找效率低。另外, 指向下一个盘块的指针也需要耗费少量的存储空间。

若此时要拓展文件, 则可以随便找一个空闲磁盘块, 挂到文件的磁盘块链尾, 并修改文件的 FCB 即可。采用隐式链接的链接分配方式, 很方便文件拓展。另外, 所有的空闲磁盘块都可以被利用, 不会有碎片问题, 外存利用率高。

- 优点：很方便文件拓展, 不会有碎片问题, 外存利用率高
- 缺点：只支持顺序访问, 不支持随机访问, 查找效率低, 指向下一个盘块的指针也需要耗费少量的存储空间

### 显式链接

新增一个文件分配表(FAT, File Allocation Table), 把用于链接文件各物理块的指针显式地存放在这张表中, 表中存放物理块号和下一块两项。

| 物理块号 | 下一块 |
| -------- | ------ |
| 0        | 10     |
| 1        | 3      |
| 2        | 100    |

文件目录中只需记录文件的起始块号。

| 文件名   | ... | 起始块号 |
| -------- | --- | -------- |
| demo_dir | ... | 9        |
| 1.jpg    | ... | 101      |

一个磁盘仅设置一张 FAT。开机时, 将 FAT 读入内存, 并常驻内存。 FAT 的各个表项在物理上连续存储, 且每一个表项长度相同, 因此“物理块号”字段可以是隐含的。

实现文件的逻辑块号到物理块号的转变: 用户给出要访问的逻辑块号 i, 操作系统找到该文件对应的目录项(FCB), 从目录项中找到起始块号, 若 i>0, 则查询内存中的文件分配表 FAT, 往后找到 i 号逻辑块对应的物理块号。逻辑块号转换成物理块号的过程不需要读磁盘操作。

采用显式链接方式的文件, 支持顺序访问, 也支持随机访问(想访问 i 号逻辑块时, 并不需要依次访问之前的 0 ~ i-1 号逻辑块), 由于块号转换的过程不需要访问磁盘, 因此相比于隐式链接来说, 访问速度快很多。显式链接也不会产生外部碎片, 也可以很方便地对文件进行拓
展。

- 优点：很方便文件拓展, 不会有碎片问题, 外存利用率高, 并且支持随机访问。相比于隐式链接来说, 地址转换时不需要访问磁盘, 因此文件的访问效率更高
- 缺点：文件分配表的需要占用一定的存储空间

## 索引分配

索引分配允许文件离散地分配在各个磁盘块中, 系统会为每个文件建立一张索引表, 索引表中记录了文件的各个逻辑块对应的物理块。在显式链接的链式分配方式中, 文件分配表 FAT 是一个磁盘对应一张。而索引分配方式中, 索引表是一个文件对应一张。

| 逻辑块号 | 物理块号 |
| -------- | -------- |
| 0        | 10       |
| 1        | 3        |
| 2        | 100      |

索引表存放的磁盘块称为索引块, 文件数据存放的磁盘块称为数据块。文件目录中需要记录文件的索引块是几号磁盘块。

| 文件名   | ... | 索引块 |
| -------- | --- | ------ |
| demo_dir | ... | 9      |
| 1.jpg    | ... | 101    |

实现文件的逻辑块号到物理块号的转变: 用户给出要访问的逻辑块号 i, 操作系统找到该文件对应的目录项(FCB), 从目录项中可知索引表(索引块)存放位置, 将索引表从外存读入内存, 并查找索引表中 i 号逻辑块在外存中的存放位置。

索引分配方式可以支持随机访问。文件拓展也很容易实现(只需要给文件分配一个空闲块, 并增加一个索引表项即可)但是索引表需要占用一定的存储空间。

若每个磁盘块 1KB, 一个索引表项 4B, 则一个磁盘块只能存放 256 个索引项。如果一个文件的大小超过了 256 块, 那么一个磁盘块是装不下文件的整张索引表的, 有三种解决方案: 链接方案, 多层索引, 混合索引。

### 链接方案

如果索引表太大, 一个索引块装不下, 那么可以将多个索引块链接起来存放。

假设磁盘块大小为 1KB, 一个索引表项占 4B, 则一个磁盘块只能存放 256 个索引项。若一个文件大小为 256 × 256KB = 65536 KB = 64MB 该文件共有 256 × 256 个块, 也就对应 256 × 256 个索引项, 也就需要 256 个索引块来存储, 这些索引块用链接方案连起来。

若想要访问文件的最后一个逻辑块, 就必须找到最后一个索引块(第 256 个索引块), 而各个索引块之间是用指针链接起来的, 因此必须先顺序地读入前 255 个索引块。

缺点: 磁盘 I/O 次数过多, 查找效率低下。

### 多层索引

多层索引的原理类似于多级页表。使第一层索引块指向第二层的索引块。还可根据文件大小的要求再建立第三层、第四层索引块。

若采用多层索引, 则各层索引表大小不能超过一个磁盘块。若某文件采用两层索引, 则该文件的最大长度可以到 256 × 256 × 1KB = 65536 KB = 64MB

可根据逻辑块号算出应该查找索引表中的哪个表项。如：要访问 1026 号逻辑块, 则 1026 / 256 = 4, 1026 % 256 = 2 因此可以先将一级索引表调入内存, 查询 4 号表项, 将其对应的二级索引表调入内存, 再查询二级索引表的 2 号表项即可知道 1026 号逻辑块存放的磁盘块号了。访问目标数据块, 需要 3 次磁盘 I/O。采用 K 层索引结构, 且顶级索引表未调入内存, 则访问一个数据块只需要 K + 1 次。

缺点：即使是小文件, 访问一个数据块依然需要 K+1 次读磁盘。

### 混合索引

多种索引分配方式的结合。例如, 一个文件的顶级索引表中, 既包含直接地址索引(直接指向数据块), 又包含一级间接索引(指向单层索引表)、还包含两级间接索引(指向两层索引表)。

优点：对于小文件来说, 访问一个数据块所需的读磁盘次数更少。
