# 文件存储空间管理

存储空间的划分：将物理磁盘划分为一个个文件卷(逻辑卷、逻辑盘)。

存储空间的初始化：将各个文件卷划分为目录区、文件区。目录区主要存放文件目录信息(FCB)、用于磁盘存储空间管理的信息。文件区用于存放文件数据。

文件存储空间的管理方法:

- 空闲表法
- 空闲链表法
- 位示图法
- 成组链接法

## 空闲表法

适用于物理结构为连续分配方式的文件。

空闲盘块表:

| 第一个空闲盘块号 | 空闲盘块数 |
| ---------------- | ---------- |
| 0                | 10         |
| 5                | 3          |
| 100              | 111        |

为文件分配空闲的磁盘块：与内存管理中的动态分区分配很类似, 为一个文件分配连续的存储空间。同样可采用首次适应、最佳适应、最坏适应等算法来决定要为文件分配哪个区间。

回收不用的磁盘块：与内存管理中的动态分区分配很类似, 当回收某个存储区时需要有四种情况:

1. 回收区的前后都没有相邻空闲区
2. 回收区的前后都是空闲区
3. 回收区前面是空闲区
4. 回收区后面是空闲区

回收时需要把相邻空闲区的表项合并。

## 空闲链表法

分两种:

- 以盘块为单位组成一条空闲链, 空闲盘块中存储着下一个空闲盘块的指针
- 以盘区为单位组成一条空闲链(连续的空闲盘块组成一个空闲盘区), 空闲盘区中的第一个盘块内记录了盘区的长度、下一个盘区的指针

操作系统保存着链头、链尾指针。

### 以盘块为单位组成一条空闲链

为文件分配空闲的磁盘块：若某文件申请 K 个盘块, 则从链头开始依次取出 K 个盘块分配, 并修改空闲链的链头指针。

回收不用的磁盘块：回收的盘块依次挂到链尾, 并修改空闲链的链尾指针。

适用于离散分配的物理结构。为文件分配多个盘块时可能要重复多次操作。

### 以盘区为单位组成一条空闲链

为文件分配空闲的磁盘块：若某文件申请 K 个盘块, 则可以采用首次适应、最佳适应等算法, 从链头开始检索, 按照算法规则找到一个大小符合要求的空闲盘区, 分配给文件。若没有合适的连续空闲块, 也可以将不同盘区的盘块同时分配给一个文件, 分配后要修改相应的链指针、盘区大小等数据。

回收不用的磁盘块：若回收区和某个空闲盘区相邻, 则需要将回收区合并到空闲盘区中。若回收区没有和任何空闲区相邻, 将回收区作为单独的一个空闲盘区挂到链尾。

离散分配、连续分配都适用。为一个文件分配多个盘块时效率更高。

## 位示图法

行是位号, 列是字号:

|     |     |     |     |     |     |
| --- | --- | --- | --- | --- | --- |
| 0   | 1   | 2   | 3   | 4   | ... |
| 1   | 0   | 1   | 0   | 1   | ... |
| 2   | 0   | 0   | 1   | 0   | ... |
| 3   | 1   | 1   | 0   | 0   | ... |
| 4   | 0   | 0   | 1   | 0   | ... |
| ... | ... | ... | ... | ... | ... |

位示图中的每个二进制位对应一个盘块。比如, 0 代表盘块空闲, 1 代表盘块已分配。位示图一般用连续的“字”来表示, 比如一个字的字长是 16 位, 字中的每一位对应一个盘块。因此可以用 `(字号, 位号)` 对应一个盘块号。

如果字号, 位号, 盘块号都是从 0 开始的, 字长为 n, 则:

- `(字号, 位号)` 为 `(i, j)` 的二进制位对应的盘块号 b 是 `ni + j`
- b 号盘块对应的字号 i 是`b / n`, 位号 j 是 `b % n`

为文件分配空闲的磁盘块：若文件需要 K 个盘块, 1. 顺序扫描位示图, 找到 K 个相邻或不相邻的 0。2. 根据字号、位号算出对应的盘块号, 将相应盘块分配给文件。3. 将相应位设置为 1。

回收不用的磁盘块：1. 根据回收的盘块号计算出对应的字号、位号。2. 将相应二进制位设为 0。

## 成组链接法

空闲表法、空闲链表法不适用于大型文件系统, 因为空闲表或空闲链表可能过大。UNIX 系统中采用了成组链接法对磁盘空闲块进行管理。

在成组链接法中, 磁盘上的空闲块被分成若干组, 通常每组包含 100 个空闲块。
