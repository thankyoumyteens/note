# 分页存储管理

将内存空间分为一个个大小相等的分区(比如:每个分区 4KB)，每个分区就是一个“页框”或“内存块”。每个页框有一个编号，即“页框号”，页框号从 0 开始。

将进程的逻辑地址空间也分为与页框大小相等的一个个部分，每个部分称为一个“页”或“页面”。每个页面也有一个编号，即“页号”，页号也是从 0 开始。

操作系统以页框为单位为各个进程分配内存空间。进程的每个页面分别放入一个页框中。也就是说，进程的页面与内存的页框有一一对应的关系。各个页面不必连续存放，可以放到不相邻的各个页框中。

## 页表

为了能知道进程的每个页面在内存中存放的位置，操作系统要为每个进程建立一张页表。

1. 一个进程对应一张页表
2. 进程的每个页面对应一个页表项
3. 每个页表项由“页号”和“块号”组成
4. 页表记录进程页面和实际存放的内存块之间的映射关系
5. 每个页表项的长度是相同的

![](../img/p1.jpg)

注意：页表记录的只是内存块号，而不是内存块的起地址。i 号内存块的起始地址为： `i * 内存块大小`。

## 每个页表项占多少字节

假设某系统物理内存大小为 4GB，页面大小为 4KB，则每个页表项至少应该为多少字节?

块号至少占用的字节:

1. 内存块大小=页面大小=4KB= 2^12 B
2. 4GB 的内存总共会被分为 2^32 / 2^12 = 2^20 个内存块
3. 内存块号的范围应该是 0 ~ 2^20 -1
4. 内存块号至少要用 20 bit 来表示, 即至少要用 3B 来表示块号(3\*8=24bit)

页表项连续存放，因此页号可以是隐含的，不占存储空间(类比数组的索引)

## 如何实现地址的转换

如果要访问逻辑地址 A，则:

1. 确定逻辑地址 A 对应的“页号”P
2. 找到 P 号页面在内存中的起始地址(需要查页表)
3. 确定逻辑地址 A 的“页内偏移量”W
4. 逻辑地址 A 对应的物理地址为: `P号页面在内存中的起始地址 + 页内偏移量W`

页号 = `逻辑地址 / 页面长度` (取除法的整数部分)

页内偏移量 = `逻辑地址 % 页面长度` (取除法的余数部分)

例: 在某计算机系统中，页面大小是 50B。某进程逻辑地址空间大小为 200B，则逻辑地址 110 对应 的页号、页内偏移量是多少?

1. 页号 = 110 / 50 = 2
2. 页内偏移量 = 110 % 50 = 10

在计算机内部，地址是用二进制表示的，如果页面大小是 2 的整数幂，则计算机硬件可以很快速的把逻辑地址拆分出页号和页内偏移量。

如果每个页面大小为 2^K 字节，用二进制数表示逻辑地址，则末尾 K 位即为页内偏移量，其余部分就是页号。并且只需把页表中记录的块号拼接上页内偏移量就能得到对应的物理地址。

例如: 页面大小为 4KB = 2^12 字节 = 4096 字节, 则逻辑地址 4097 的页号和页内偏移量:

1. 4097 用二进制表示 `00000000000000000001 000000000001`
2. 页内偏移量是后 12 位: `000000000001`, 等于 `4097 / 4096 = 1`
3. 页号是其余部分: `00000000000000000001`, 等于 `4097 % 4096 = 1`
4. 假设页号 1 对应的块号是 9(二进制 1001), 则物理地址为: `1001 000000000001`
