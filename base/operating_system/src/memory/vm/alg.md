# 页面置换算法

## 最佳置换算法(OPT)

最佳置换算法(OPT，Optimal): 每次选择淘汰的页面将是以后永不使用，或者在最长时间内不再被访问的页面，这样可以保证最低的缺页率。

例:假设系统为某进程分配了三个内存块，进程会依次访问以下页面: 7, 0, 1, 2, 0, 3, 0, 4, 2, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1。

1. 首先访问 7 号页面, 此时 3 个内存块都可以使用
2. 访问 0 号页面, 此时有 2 个内存块可以使用
3. 访问 1 号页面, 此时有 1 个内存块可以使用
4. 访问 2 号页面, 此时没有内存块可以使用, 需要使用页面置换算法把某个页面换出内存块。最佳置换算法会检查后续要访问的页面, 7, 0, 1 中最后出现的页号就是要换出的页面。0, 3, 0, 4, 2, 3, 0, 3, 2, 1, 2, 0, 1, 7, 0, 1。所以把 7 号页面换出内存, 把 2 号页面放入原 7 号页面所在的内存块
5. ...

最佳置换算法可以保证最低的缺页率，但实际上，只有在进程执行的过程中才能知道接下来会访问到的是哪个页面。操作系统无法前预判页面访问序列。因此，最佳置换算法是无法实现的。

## 先进先出置换算法(FIFO)

先进先出置换算法(FIFO): 每次选择淘汰的页面是最早进入内存的页面。实现方法: 把调入内存的页面根据调入的先后顺序排成一个队列，需要换出页面时选择队头页面即可。队列的最大长度取决于系统为进程分配了多少个内存块。

Belady 异常: 当为进程分配的内存块数增大时，触发缺页中断的次数不减反增的异常现象。比如, 分配三个内存块时，缺页次数是 9 次, 而分配四个内存块时，缺页次数是 10 次。只有 FIFO 算法会产生 Belady 异常。

FIFO 算法虽然实现简单，但是该算法与进程实际运行时的 规律不适应，因为先进入的页面也有可能最经常被访问。因此，算法性能差。

## 最近最久未使用置换算法(LRU)

最近最久未使用置换算法(LRU，least recently used): 每次淘汰的页面是最近最久未使用的页面。实现方法: 在每个页面对应的页表项中, 使用访问位记录该页面自上次被访问以来所经历的时间 t。当需要淘汰一个页面时，选择现有页面中 t 值最大的，即最近最久未使用的页面。

该算法的实现需要专门的硬件支持，虽然算法性能好，但是实现困难，开销大。

## 时钟置换算法(CLOCK)

最佳置换算法性能最好，但无法实现;先进先出置换算法实现简单，但算法性能差。最近最久未使用置换算法性能好，是最接近 OPT 算法性能的，但是实现起来需要专门的硬件支持，算法开销大。时钟置换算法是一种性能和开销较均衡的算法，又称 CLOCK 算法，或最近未用算法(NRU，Not Recently Used)。

简单的 CLOCK 算法实现方法: 使用每个页面的页表项中的访问位，并将目前在内存中的所有页面连接成一个循环队列。当某页被访问时，其访问位修改成 1。当需要淘汰一个页面时，只需扫描循环队列, 检查页表项的访问位。如果是 0，就选择该页换出。如果是 1，则将它置为 0，暂不换出，继续检查下一个页面，若第一轮扫描中所有页面都是 1，则将这些页面的访问位依次置为 0 后，再进行第二轮扫描(第二轮扫描中一定会有访问位为 0 的页面，因此简单的 CLOCK 算法选择一个淘汰页面最多会经过两轮扫描)。扫描循环队列的过程就像时钟的指针在旋转一样, 所以称为 CLOCK 算法。

## 改进型的时钟置换算法

简单的时钟置换算法仅考虑到一个页面最近是否被访问过。事实上，如果被淘汰的页面没有被修改过，就不需要执行 I/O 操作写回外存。只有被淘汰的页面被修改过时，才需要写回外存。

因此，除了考虑一个页面最近有没有被访问过之外，操作系统还应考虑页面有没有被修改过。在其它条件都相同时，应优先淘汰没有修改过的页面，避免 I/O 操作。这就是改进型的时钟置换算法的思想。页表项中的修改位是 0，表示页面没有被修改过。修改位是 1，表示页面被修改过。

算法规则: 将所有可能被置换的页面排成一个循环队列, 用 `(访问位，修改位)` 的形式表示各页面状态。如 `(1，1)` 表示一个页面近期被访问过，且被修改过:

1. 第一轮: 从当前位置开始扫描到第一个(0, 0)的页面用于替换。本轮扫描不修改任何标志位
2. 第二轮: 若第一轮扫描没找到，则重新扫描，查找第一个(0, 1)的页面用于替换。本轮将所有扫描过的页面的访问位设为 0
3. 第三轮: 若第二轮扫描没找到，则重新扫描，查找第一个(0, 0)的页面用于替换。本轮扫描不修改任何标志位
4. 第四轮: 若第三轮扫描没找到，则重新扫描，查找第一个(0, 1)的页面用于替换

由于第二轮已将所有页面的访问位设为 0，因此经过第三轮、第四轮扫描一定会有一个页面被选中，因此改进型 CLOCK 置换算法选择一个淘汰页面最多会进行四轮扫描。
